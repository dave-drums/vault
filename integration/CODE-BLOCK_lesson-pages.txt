<!-- WHERE: /vault/* → Code Block -->
<!-- PURPOSE: Inject rendered lesson UI from master *.txt file (Firebase Storage) -->

<!-- COURSE PAGE CODE BLOCK - UPDATED -->

<style>
.gs1-course-container {
  max-width: 1280px;
  margin: 0 auto;
}

.gs1-course-container p {
  margin: 0;
}

.gs1-progress-section {
  margin-bottom: 40px;
}

.gs1-progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.gs1-progress-bar-bg {
  width: 100%;
  height: 17px;
  background-color: #f0f0f0f0;
  border-radius: 10px;
  overflow: hidden;
}

.gs1-progress-bar-fill {
  height: 100%;
  background-color: #06b3fd;
  border-radius: 13px;
  transition: width 0.3s ease;
}

.gs1-chapter {
  margin-bottom: 50px;
}

.gs1-chapter-header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e1e1e1;
}

.gs1-chapter-title {
  margin: 0;
}

.gs1-lessons-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 16px;
}

.gs1-lesson-item {
  background-color: #f7f7f7;
  padding: 20px 24px;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  transition: background-color 0.2s ease;
  cursor: pointer;
}

.gs1-lesson-item:hover {
  background-color: #ececec;
}

.gs1-lesson-link {
  flex: 1;
  user-select: none;
}

.gs1-lesson-status {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid #d0d0d0;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: all 0.15s ease;
}

.gs1-lesson-status.completed {
  background-color: #06b3fd;
  border-color: #06b3fd;
}

.gs1-lesson-status.completed::after {
  content: '✓';
  color: white;
  font-size: 16px;
  font-weight: bold;
}

.gs1-lesson-status.incomplete {
  background-color: #fff;
  border: 2px solid #d0d0d0;
}

.course-progress-bar {
  height: 100%;
  background-color: #06b3fd;
  border-radius: 10px;
  transition: width 0.3s ease;
}

.vault-comments {
  margin-top: 60px;
  padding: 24px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 12px;
}

.vault-comments h3 {
  margin: 0 0 12px 0;
  font-size: 18px;
}

#vault-comment-text {
  width: 100%;
  min-height: 80px;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 14px;
  resize: vertical;
  box-sizing: border-box;
  margin-bottom: 8px;
  font-family: inherit;
}

#vault-comment-post {
  padding: 10px 20px;
  background: #06b3fd;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

#vault-comment-post:hover {
  background: #0597dc;
}

.vault-comment {
  padding: 16px;
  border-bottom: 1px solid #f0f0f0;
  margin-bottom: 8px;
}

.vault-comment-author {
  font-weight: 600;
  margin-bottom: 4px;
}

.vault-comment-time {
  font-size: 12px;
  color: #999;
  margin-bottom: 8px;
}

.vault-comment-text {
  line-height: 1.6;
  margin-bottom: 8px;
}

.vault-comment-actions {
  display: flex;
  gap: 12px;
  font-size: 13px;
}

.vault-comment-actions button {
  background: none;
  border: none;
  color: #06b3fd;
  cursor: pointer;
  padding: 0;
  font-size: 12px;
}

.vault-comment-actions button:hover {
  text-decoration: underline;
}

.vault-comment-reply {
  margin-left: 40px;
  border-left: 2px solid #e0e0e0;
  padding-left: 16px;
}

@media (max-width: 768px) {
  .gs1-lessons-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<div id="course-index" class="gs1-course-container">
  
  <div class="gs1-progress-section">
    <div class="gs1-progress-header">
      <p class="sqsrte-medium course-progress-text">0/23 (0%)</p>
      <p class="sqsrte-lmedium">Progress</p>
    </div>
    <div class="gs1-progress-bar-bg">
      <div class="gs1-progress-bar-fill course-progress-bar" style="width: 0%;"></div>
    </div>
  </div>

  <div class="gs1-chapter">
    <div class="gs1-chapter-header">
      <p class="gs1-chapter-title sqsrte-large">Eighth Note Grooves</p>
      <span class="gs1-chapter-count">4 Lessons</span>
    </div>
    <div class="gs1-lessons-grid">
      <div class="gs1-lesson-item" data-lesson="1.01">
        <div class="gs1-lesson-link sqsrte-small">G1.01 Start Here</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.02">
        <div class="gs1-lesson-link sqsrte-small">G1.02 Kick Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.03">
        <div class="gs1-lesson-link sqsrte-small">G1.03 Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.04">
        <div class="gs1-lesson-link sqsrte-small">G1.04 Kick & Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
    </div>
  </div>

  <div class="gs1-chapter">
    <div class="gs1-chapter-header">
      <p class="gs1-chapter-title sqsrte-large">Eighth Note Grooves – Linear</p>
      <span class="gs1-chapter-count">4 Lessons</span>
    </div>
    <div class="gs1-lessons-grid">
      <div class="gs1-lesson-item" data-lesson="1.05">
        <div class="gs1-lesson-link sqsrte-small">G1.05 Start Here</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.06">
        <div class="gs1-lesson-link sqsrte-small">G1.06 Kick Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.07">
        <div class="gs1-lesson-link sqsrte-small">G1.07 Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.08">
        <div class="gs1-lesson-link sqsrte-small">G1.08 Kick & Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
    </div>
  </div>

  <div class="gs1-chapter">
    <div class="gs1-chapter-header">
      <p class="gs1-chapter-title sqsrte-large">Sixteenth Note Grooves – One Handed</p>
      <span class="gs1-chapter-count">4 Lessons</span>
    </div>
    <div class="gs1-lessons-grid">
      <div class="gs1-lesson-item" data-lesson="1.09">
        <div class="gs1-lesson-link sqsrte-small">G1.09 Start Here</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.10">
        <div class="gs1-lesson-link sqsrte-small">G1.10 Kick Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.11">
        <div class="gs1-lesson-link sqsrte-small">G1.11 Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.12">
        <div class="gs1-lesson-link sqsrte-small">G1.12 Kick & Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
    </div>
  </div>

  <div class="gs1-chapter">
    <div class="gs1-chapter-header">
      <p class="gs1-chapter-title sqsrte-large">Sixteenth Note Grooves – Two Handed</p>
      <span class="gs1-chapter-count">4 Lessons</span>
    </div>
    <div class="gs1-lessons-grid">
      <div class="gs1-lesson-item" data-lesson="1.13">
        <div class="gs1-lesson-link sqsrte-small">G1.13 Start Here</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.14">
        <div class="gs1-lesson-link sqsrte-small">G1.14 Kick Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.15">
        <div class="gs1-lesson-link sqsrte-small">G1.15 Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.16">
        <div class="gs1-lesson-link sqsrte-small">G1.16 Kick & Snare Variations</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
    </div>
  </div>

  <div class="gs1-chapter">
    <div class="gs1-chapter-header">
      <p class="gs1-chapter-title sqsrte-large">Hi-Hat Control</p>
      <span class="gs1-chapter-count">7 Lessons</span>
    </div>
    <div class="gs1-lessons-grid">
      <div class="gs1-lesson-item" data-lesson="1.17">
        <div class="gs1-lesson-link sqsrte-small">G1.17 Two & Four</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.18">
        <div class="gs1-lesson-link sqsrte-small">G1.18 Quarter Notes</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.19">
        <div class="gs1-lesson-link sqsrte-small">G1.19 Off Beats</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.20">
        <div class="gs1-lesson-link sqsrte-small">G1.20 Eighth Notes</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.21">
        <div class="gs1-lesson-link sqsrte-small">G1.21 Open Hi-Hats 1</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.22">
        <div class="gs1-lesson-link sqsrte-small">G1.22 Open Hi-Hats 2</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
      <div class="gs1-lesson-item" data-lesson="1.23">
        <div class="gs1-lesson-link sqsrte-small">G1.23 Open Hi-Hats 3</div>
        <div class="gs1-lesson-status incomplete"></div>
      </div>
    </div>
  </div>

</div>

<div id="lesson-content" style="display:none;"></div>

<script>
(function() {
  'use strict';
  
  const urlParams = new URLSearchParams(window.location.search);
  const lessonId = urlParams.get('lesson');
  
  const path = window.location.pathname;
  const pathParts = path.split('/').filter(p => p.length > 0);
  const courseId = pathParts.length >= 2 && pathParts[0] === 'vault' ? pathParts[1] : null;
  
  if (lessonId && courseId) {
    document.getElementById('course-index').style.display = 'none';
    document.getElementById('lesson-content').style.display = 'block';
    loadLesson(courseId, lessonId);
  }
  
  async function loadLesson(course, lesson) {
    firebase.auth().onAuthStateChanged(async function(user) {
      if (!user) {
        showError('You must be logged in to view lessons.');
        return;
      }
      
      try {
        const storage = firebase.storage();
        const fileRef = storage.ref(`courses/${course}.txt`);
        const downloadUrl = await fileRef.getDownloadURL();
        const response = await fetch(downloadUrl);
        
        if (!response.ok) {
          showError(`Failed to fetch ${course}.txt (HTTP ${response.status})`);
          return;
        }
        
        const fileContent = await response.text();
        const extracted = extractLesson(fileContent, lesson);
        
        if (!extracted) {
          const available = extractAllLessonIds(fileContent);
          showError(`Lesson "${lesson}" not found. Available: ${available.join(', ')}`);
          return;
        }
        
        renderLesson(extracted.content, extracted.title, course);
        
      } catch (error) {
        showError(`Error: ${error.message}`);
        console.error(error);
      }
    });
  }
  
  function extractAllLessonIds(content) {
    content = content.replace(/\r\n/g, '\n');
    const headerRegex = /^===\s*LESSON\s+([\d.]+)\s*(?:\|\s*(.+?))?\s*===\s*$/gm;
    const ids = [];
    let match;
    while ((match = headerRegex.exec(content)) !== null) {
      ids.push(match[1].trim());
    }
    return ids;
  }
  
  function extractLesson(content, lessonId) {
    content = content.replace(/\r\n/g, '\n');
    const targetId = lessonId.trim();
    const headerRegex = /^===\s*LESSON\s+([\d.]+)\s*(?:\|\s*(.+?))?\s*===\s*$/gm;
    
    const headers = [];
    let match;
    
    while ((match = headerRegex.exec(content)) !== null) {
      headers.push({
        id: match[1].trim(),
        title: match[2] ? match[2].trim() : null,
        startPos: match.index,
        headerEndPos: match.index + match[0].length
      });
    }
    
    const targetIndex = headers.findIndex(h => h.id === targetId);
    if (targetIndex === -1) return null;
    
    const targetHeader = headers[targetIndex];
    const start = targetHeader.headerEndPos;
    const end = headers[targetIndex + 1]?.startPos ?? content.length;
    
    const lessonContent = content.substring(start, end).trim();
    const lessonTitle = targetHeader.title || `Lesson ${targetId}`;
    
    return { content: lessonContent, title: lessonTitle };
  }
  
  function renderLesson(content, title, courseId) {
    if (!window.vaultParse) {
      setTimeout(function() { renderLesson(content, title, courseId); }, 100);
      return;
    }
    
    const tokens = window.vaultParse.tokenise(content);
    const renderedDOM = window.vaultParse.render(tokens);
    
    const container = document.getElementById('lesson-content');
    container.innerHTML = '';
    
    const buttonContainer = document.createElement('div');
    buttonContainer.style.cssText = 'display:flex;justify-content:space-between;align-items:flex-start;margin:0 0 20px 0;';
    
    const backBtn = document.createElement('a');
    backBtn.href = window.location.pathname;
    backBtn.textContent = '← Back to Course';
    backBtn.className = 'p3';
    backBtn.style.cssText = 'display:inline-block;padding:10px 16px;background:#f3f3f3;' +
      'border:1px solid #ddd;border-radius:6px;text-decoration:none;color:#333;transition:all 0.2s;' +
      'font-size:14px;';
    backBtn.addEventListener('mouseenter', function(){ backBtn.style.background = '#e8e8e8'; });
    backBtn.addEventListener('mouseleave', function(){ backBtn.style.background = '#f3f3f3'; });
    buttonContainer.appendChild(backBtn);
    
    const topButtonPlaceholder = document.createElement('div');
    topButtonPlaceholder.id = 'complete-button-top';
    buttonContainer.appendChild(topButtonPlaceholder);
    
    container.appendChild(buttonContainer);
    container.appendChild(renderedDOM);
    
    const bottomButtonPlaceholder = document.createElement('div');
    bottomButtonPlaceholder.id = 'complete-button-bottom';
    bottomButtonPlaceholder.style.cssText = 'margin-top:40px;';
    container.appendChild(bottomButtonPlaceholder);
    
    const commentsHTML = `
      <div id="vault-comments" class="vault-comments">
        <h3>Lesson Comments</h3>
        <div id="vault-comments-meta" style="font-size:14px;color:#666;margin-bottom:16px;"></div>
        <div id="vault-comments-list" style="margin-bottom:24px;"></div>
        <form id="vault-comment-form">
          <textarea id="vault-comment-text" placeholder="Add a comment..."></textarea>
          <div style="display:flex;justify-content:flex-end;">
            <button type="submit" id="vault-comment-post">Post Comment</button>
          </div>
        </form>
        <div id="vault-comment-status" style="margin:8px 0;color:#c00;font-size:14px;"></div>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', commentsHTML);
    
    const courseConfig = window.VAULT_COURSES && window.VAULT_COURSES[courseId];
    const courseName = courseConfig ? courseConfig.name : courseId.toUpperCase();
    document.title = title + ' | ' + courseName;
    
    if (window.VaultAudioPlayer?.scan) {
      window.VaultAudioPlayer.scan();
    }
    
    // Wait for comments container to be in DOM, then initialize
    setTimeout(function() {
      if (typeof window.initVaultComments === 'function') {
        window.initVaultComments();
      }
    }, 200);
  }
  
  function showError(message) {
    const container = document.getElementById('lesson-content');
    container.innerHTML = `<div style="padding:20px;border:2px solid #d00;background:#ffe;color:#d00;margin:20px;font-family:monospace;">${message}</div>`;
  }
})();
</script>

