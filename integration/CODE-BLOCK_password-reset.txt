<!-- WHERE: /reset → Code Block -->
<!-- PURPOSE: User password reset -->

<style>
#members-wrap{
  max-width:480px;
  margin:60px auto;
  padding:32px;
  border-radius:10px;
  background:#fff;
  box-shadow:0 8px 28px rgba(0,0,0,.18);
}

.members-title{
  text-align:center;
  margin:0 0 24px;
}

#members-message{
  text-align:center;
  margin:8px 0 18px 0;
  min-height:20px;
  font-family:inherit;
  font-weight:inherit;
  font-size:inherit;
  color:inherit;
}

#reset-email{
  text-align:center;
  margin:0 0 18px;
}

.reset-label{
  display:block;
  margin-bottom:6px;
}

.reset-input{
  display:block;
  width:100%;
  box-sizing:border-box;
  padding:10px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-bottom:18px;
}

#reset-save-btn{
  width:100%;
  padding:12px;
  background:#06b3fd;
  border-radius:6px;
  border:1px solid #06b3fd;
  color:#fff;
  cursor:pointer;
  font:inherit;
}
#reset-save-btn:hover{
  background:#0494d3;
  border-color:#0494d3;
}
</style>

<div id="members-wrap">
  <h3 class="members-title">RESET PASSWORD</h3>

  <div id="members-message"></div>
  <p id="reset-email"></p>

  <label class="reset-label" for="reset-password">New password</label>
  <input id="reset-password" class="reset-input" type="password">

  <label class="reset-label" for="reset-password2">Confirm new password</label>
  <input id="reset-password2" class="reset-input" type="password">

  <button id="reset-save-btn">Save password</button>
</div>

<script>
function setMembersMsg(t,isErr){
  var el=document.getElementById('members-message');
  if(el){
    el.textContent=t;
    el.style.color=isErr?'#c00':'#090';
  }
}

function friendlyResetError(err){
  var code=err && err.code ? err.code : '';
  var map={
    'auth/weak-password':'Please choose a stronger password (at least 6 characters).',
    'auth/expired-action-code':'This password reset link has expired. Please request a new reset from the Members page.',
    'auth/invalid-action-code':'This password reset link is invalid. Please request a new reset from the Members page.'
  };
  if(map[code]) return map[code];
  return 'Something went wrong. Please request a new reset from the Members page.';
}

document.addEventListener('DOMContentLoaded',function(){
  if(typeof firebase==='undefined' || !firebase.auth){
    setMembersMsg('System error – please try again later.',1);
    return;
  }

  var auth=firebase.auth();
  var params=new URLSearchParams(window.location.search);
  var mode=params.get('mode');
  var oobCode=params.get('oobCode');

  if(mode!=='resetPassword' || !oobCode){
    setMembersMsg('This password reset link is invalid. Please use the link from your email, or request a new reset from the Members page.',1);
    return;
  }

  var emailEl=document.getElementById('reset-email');
  var passEl=document.getElementById('reset-password');
  var pass2El=document.getElementById('reset-password2');
  var saveBtn=document.getElementById('reset-save-btn');

  auth.verifyPasswordResetCode(oobCode)
    .then(function(email){
      if(emailEl) emailEl.textContent='For ' + email;
    })
    .catch(function(err){
      setMembersMsg(friendlyResetError(err),1);
    });

  if(!saveBtn) return;

  saveBtn.addEventListener('click',function(){
    var newPass=passEl.value;
    var newPass2=pass2El.value;

    if(!newPass || newPass.length<6){
      setMembersMsg('Please enter a password of at least 6 characters.',1);
      return;
    }
    if(newPass!==newPass2){
      setMembersMsg('Passwords do not match. Please retype them.',1);
      return;
    }

    auth.confirmPasswordReset(oobCode,newPass)
      .then(function(){
        setMembersMsg('Password updated. Redirecting you to the Members page…',0);
        setTimeout(function(){ window.location.href='/members'; },2000);
      })
      .catch(function(err){
        setMembersMsg(friendlyResetError(err),1);
      });
  });
});
</script>
