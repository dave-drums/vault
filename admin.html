<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Console - Practice Vault</title>
  <link rel="icon" href="/assets/favicon.ico">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Typography Variables -->
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/core.css">
  <link rel="stylesheet" href="/css/admin.css">
  
  <!-- Firebase -->
  <script src="/firebase/firebase-app-compat.js"></script>
  <script src="/firebase/firebase-auth-compat.js"></script>
  <script src="/firebase/firebase-firestore-compat.js"></script>
  <script src="/firebase/firebase-init.js"></script>
  
  <!-- Mark page as protected (requires login + admin) -->
  <script>document.documentElement.dataset.protected = 'true';</script>
  <script src="/config/auth-guard.js"></script>
  
  <!-- Error Handler for Toast notifications -->
  <script src="/config/error-handler.js"></script>
  
  <!-- Components for Toast notifications -->
  <script src="/config/components.js"></script>
  <script src="/config/navigation.js"></script>
  
  <style>
    /* Tab Navigation Styles */
    .tabs-nav {
      display: flex;
      gap: 8px;
      border-bottom: 2px solid #e9ecef;
      margin-bottom: 32px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 15px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      bottom: -2px;
      font-family: 'Inter', sans-serif;
    }
    .tab-btn:hover {
      color: #1a1a2e;
    }
    .tab-btn.active {
      color: #06b3fd;
      border-bottom-color: #06b3fd;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Progress Modal Improvements */
    .progress-search {
      padding: 16px 24px;
      border-bottom: 1px solid #e9ecef;
      background: #f8f9fa;
    }
    .search-input {
      width: 100%;
      padding: 10px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    .pathway-tabs {
      display: flex;
      border-bottom: 2px solid #e9ecef;
      background: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .pathway-tab {
      flex: 1;
      padding: 14px 16px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-size: 14px;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      bottom: -2px;
      font-family: inherit;
      text-align: center;
    }
    .pathway-tab:hover {
      color: #1a1a2e;
      background: #f8f9fa;
    }
    .pathway-tab.active {
      color: #06b3fd;
      border-bottom-color: #06b3fd;
      background: white;
    }
    .pathway-badge {
      display: inline-block;
      background: #e9ecef;
      color: #666;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 6px;
      font-weight: 500;
    }
    .pathway-tab.active .pathway-badge {
      background: #e0f2fe;
      color: #06b3fd;
    }
    .pathway-content {
      display: none;
      padding: 16px 0;
    }
    .pathway-content.active {
      display: block;
    }
    .course-section {
      margin: 0 24px 12px 24px;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      overflow: hidden;
      background: white;
    }
    .course-header {
      padding: 16px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
      user-select: none;
    }
    .course-header:hover {
      background: #f8f9fa;
    }
    .course-info {
      flex: 1;
      min-width: 0;
    }
    .course-name {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 4px;
    }
    .course-meta {
      font-size: 13px;
      color: #666;
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .course-level {
      display: inline-block;
      background: #e9ecef;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .course-stats {
      font-size: 14px;
      color: #666;
    }
    .course-arrow {
      font-size: 20px;
      color: #999;
      transition: transform 0.2s;
    }
    .course-section.expanded .course-arrow {
      transform: rotate(180deg);
    }
    .course-progress-bar {
      height: 4px;
      background: #e9ecef;
      margin: 0 20px 16px 20px;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #06b3fd, #38bdf8);
      transition: width 0.3s;
    }
    .course-lessons {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .course-section.expanded .course-lessons {
      max-height: 2000px;
    }
    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      padding: 0 20px 16px 20px;
    }
    .lesson-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 10px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .lesson-item:hover {
      background: #fff;
      border-color: #06b3fd;
    }
    .lesson-item.completed {
      background: #d1fae5;
      border-color: #10b981;
    }
    .lesson-id {
      font-weight: 500;
      color: #1a1a2e;
    }
    .lesson-toggle {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid #e0e0e0;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }
    .lesson-toggle.completed {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }
    @media (max-width: 768px) {
      .lesson-grid {
        grid-template-columns: repeat(4, 1fr);
      }
      .pathway-tab {
        font-size: 12px;
        padding: 12px 8px;
      }
      .pathway-badge {
        display: none;
      }
    }
  </style>
  
</head>
<body>
  <div id="page-loader" class="page-loader">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Hero Section -->
<div class="hero">
  <div class="hero-banner" data-bg="home"></div>
  <div class="hero-content">
    <h1 class="hero-title">Admin Dashboard</h1>
    <div class="hero-badge">Management Console</div>
  </div>
</div>
  
  <!-- Main Container -->
  <div class="admin-container">
    <!-- Tab Navigation -->
    <div class="tabs-nav">
      <button class="tab-btn active" data-tab="students">Students</button>
      <button class="tab-btn" data-tab="invites">Invites</button>
      <button class="tab-btn" data-tab="videos">Video Submissions</button>
    </div>
    
    <!-- Tab Contents -->
    <div id="students-tab" class="tab-content active"></div>
    <div id="invites-tab" class="tab-content"></div>
    <div id="videos-tab" class="tab-content">
      <div class="admin-section">
        <div style="text-align: center; padding: 60px 20px; color: #999;">
          <div style="font-size: 64px; margin-bottom: 16px; opacity: 0.3;">üé•</div>
          <h3 style="font-size: 18px; margin: 0 0 8px 0; color: #666;">Coming Soon</h3>
          <p style="margin: 0; font-size: 14px;">Video submission system will be added here</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Admin Console Logic -->
  <script src="/config/course-data.js"></script>
  <script>
(function(){
var db;
var auth;
var studentsTabEl;
var invitesTabEl;

function pvGetFontBaseEl(){
  return (
    document.querySelector('.sqs-block-content') ||
    document.querySelector('.sqs-layout') ||
    document.getElementById('students-tab') ||
    document.body
  );
}
function pvApplyFontFromBase(el){
  var baseEl = pvGetFontBaseEl();
  var cs = window.getComputedStyle(baseEl);
  if (cs.font && cs.font !== 'normal') el.style.font = cs.font;
  el.style.fontFamily = cs.fontFamily;
  el.style.fontSize = cs.fontSize;
  el.style.fontWeight = cs.fontWeight;
  el.style.lineHeight = cs.lineHeight;
  el.style.color = cs.color;
}

function escapeHtml(s){
  return String(s || '').replace(/[&<>"']/g, function (c) {
    return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c];
  });
}
function tsToMs(ts){
  if (!ts || !ts.toDate) return 0;
  try { return ts.toDate().getTime(); } catch (e) { return 0; }
}
function formatTs(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleString('en-AU', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Australia/Brisbane'
  });
}
function formatTsNoYear(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleString('en-AU', {
    day: 'numeric',
    month: 'short',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Australia/Brisbane'
  });
}
function formatDateOnly(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleDateString('en-AU', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    timeZone: 'Australia/Brisbane'
  });
}
function formatDuration(sec){
  sec = Number(sec || 0);
  if (sec <= 0) return '0 min';
  var mins = Math.round(sec / 60);
  if (mins < 60) return mins + ' min';
  var hours = Math.floor(mins / 60);
  var rem = mins % 60;
  return rem === 0 ? hours + ' hrs' : hours + ' hrs ' + rem + ' min';
}
function formatAvgTime(totalSeconds, loginCount){
  totalSeconds = Number(totalSeconds || 0);
  loginCount = Number(loginCount || 0);
  if (totalSeconds <= 0 || loginCount <= 0) return '0 min';
  return formatDuration(Math.round(totalSeconds / loginCount));
}
function statusDot(lastActiveTs, joinedAtTs){
  var ms = tsToMs(lastActiveTs);
  if (!ms) ms = tsToMs(joinedAtTs);
  if (!ms) return 'üî¥';
  var days = (Date.now() - ms) / (1000 * 60 * 60 * 24);
  if (days < 14) return '';
  if (days < 30) return 'üü°';
  return 'üî¥';
}
function formatRelativeTime(ts){
  if (!ts || !ts.toDate) return '';
  var ms = tsToMs(ts);
  if (!ms) return '';
  
  var now = Date.now();
  var diff = now - ms;
  var days = Math.floor(diff / (1000 * 60 * 60 * 24));
  var weeks = Math.floor(days / 7);
  var months = Math.floor(days / 30);
  var years = Math.floor(days / 365);
  
  if (days < 7) return '(' + days + ' day' + (days === 1 ? '' : 's') + ' ago)';
  if (weeks < 4) return '(' + weeks + ' week' + (weeks === 1 ? '' : 's') + ' ago)';
  if (months < 12) return '(' + months + ' month' + (months === 1 ? '' : 's') + ' ago)';
  
  var remainingMonths = months - (years * 12);
  if (remainingMonths === 0) return '(' + years + ' year' + (years === 1 ? '' : 's') + ' ago)';
  return '(' + years + ' year' + (years === 1 ? '' : 's') + ', ' + remainingMonths + ' month' + (remainingMonths === 1 ? '' : 's') + ' ago)';
}
function copyText(text){
  if (navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text);
  }
  return new Promise(function (resolve, reject) {
    try {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      var ok = document.execCommand('copy');
      document.body.removeChild(ta);
      ok ? resolve() : reject();
    } catch (e) { reject(e); }
  });
}
function showBody(){
  if (document.body) document.body.style.opacity = '1';
}

var INVITES_COL = 'invites';
var CREATE_ACCOUNT_URL_BASE = 'https://vault.davedrums.com.au/create-account?t=';

function randomToken(len){
  len = len || 16;
  try {
    var bytes = new Uint8Array(len);
    (window.crypto || window.msCrypto).getRandomValues(bytes);
    var out = '';
    for (var i = 0; i < bytes.length; i++) out += ('0' + bytes[i].toString(16)).slice(-2);
    return out;
  } catch (e) {
    return (Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2) + Date.now().toString(16)).slice(0, len * 2);
  }
}

function makeOverlay(){
  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.setAttribute('role','dialog');
  overlay.setAttribute('aria-modal','true');
  overlay.addEventListener('click', function(e){ if (e.target === overlay) overlay.remove(); });
  return overlay;
}

// NEW: Add User Modal with two-step process
function openAddUserModal(db){
  var overlay = makeOverlay();
  var box = document.createElement('div');
  box.className = 'modal-box';
  pvApplyFontFromBase(box);

  var header = document.createElement('div');
  header.className = 'modal-header';
  header.innerHTML =
    '<div style="flex:1;min-width:0;"><div class="modal-title">Add New Student</div><div class="modal-subtitle">Step 1: Enter student details</div></div>' +
    '<button type="button" class="modal-close-btn" aria-label="Close">&times;</button>';
  header.querySelector('.modal-close-btn').addEventListener('click', function(){ overlay.remove(); });
  box.appendChild(header);

  var body = document.createElement('div');
  body.className = 'modal-body';
  body.innerHTML =
    '<div class="form-group">' +
      '<label class="form-label">Email Address</label>' +
      '<input type="email" id="pv-new-email" class="form-input" placeholder="student@example.com">' +
    '</div>' +
    '<div class="form-group">' +
      '<label class="form-label">First Name</label>' +
      '<input type="text" id="pv-new-firstname" class="form-input" placeholder="John">' +
    '</div>' +
    '<div class="form-group">' +
      '<label class="form-label">Last Name</label>' +
      '<input type="text" id="pv-new-lastname" class="form-input" placeholder="Smith">' +
    '</div>' +
    '<div class="button-group">' +
      '<button type="button" class="btn btn-secondary">Cancel</button>' +
      '<button type="button" class="btn btn-primary">Next</button>' +
    '</div>';
  box.appendChild(body);
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  body.querySelector('.btn-secondary').addEventListener('click', function(){ overlay.remove(); });
  body.querySelector('.btn-primary').addEventListener('click', function(){
    var email = (box.querySelector('#pv-new-email').value || '').trim();
    var firstName = (box.querySelector('#pv-new-firstname').value || '').trim();
    var lastName = (box.querySelector('#pv-new-lastname').value || '').trim();

    if (!email) {
      if (window.VaultErrors) window.VaultErrors.handle({message:'Email is required'},'Add User');
      else alert('Email is required');
      return;
    }
    if (!firstName) {
      if (window.VaultErrors) window.VaultErrors.handle({message:'First name is required'},'Add User');
      else alert('First name is required');
      return;
    }
    if (!lastName) {
      if (window.VaultErrors) window.VaultErrors.handle({message:'Last name is required'},'Add User');
      else alert('Last name is required');
      return;
    }

    // Step 2: create token & show link
    var token = randomToken(16);
    db.collection(INVITES_COL).add({
      email: email,
      firstName: firstName,
      lastName: lastName,
      token: token,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'pending'
    }).then(function(){
      var link = CREATE_ACCOUNT_URL_BASE + encodeURIComponent(token);

      header.innerHTML =
        '<div style="flex:1;min-width:0;"><div class="modal-title">Student Invite Created!</div><div class="modal-subtitle">Share this link with ' + escapeHtml(firstName) + '</div></div>' +
        '<button type="button" class="modal-close-btn" aria-label="Close">&times;</button>';
      header.querySelector('.modal-close-btn').addEventListener('click', function(){ overlay.remove(); });

      body.innerHTML =
        '<div class="success-message">' +
          '<div class="success-icon">‚úì</div>' +
          '<div class="success-text">Invite link created!</div>' +
        '</div>' +
        '<div class="form-group">' +
          '<label class="form-label">Invite Link</label>' +
          '<input type="text" readonly class="form-input" value="' + link + '">' +
        '</div>' +
        '<p class="form-help-text">Send this link to ' + escapeHtml(firstName) + ' so they can create their account.</p>' +
        '<div class="button-group">' +
          '<button type="button" class="btn btn-secondary">Close</button>' +
          '<button type="button" class="btn btn-primary">Copy Link</button>' +
        '</div>';

      body.querySelector('.btn-secondary').addEventListener('click', function(){ overlay.remove(); });
      body.querySelector('.btn-primary').addEventListener('click', function(){
        copyText(link).then(function(){
          if (window.VaultErrors) window.VaultErrors.success('Link copied!');
          else alert('Link copied!');
        }).catch(function(e){
          if (window.VaultErrors) window.VaultErrors.handle(e, 'Copy Link');
          else alert('Failed to copy link');
        });
      });
    }).catch(function(e){
      if (window.VaultErrors) window.VaultErrors.handle(e, 'Create Invite');
      else alert('Error: ' + (e.message || e));
    });
  });
}

// Invites Modal
function openInvitesModal(db){
  var overlay = makeOverlay();
  var box = document.createElement('div');
  box.className = 'modal-box modal-box-wide modal-box-full-height';
  pvApplyFontFromBase(box);

  var header = document.createElement('div');
  header.className = 'modal-header';
  header.innerHTML =
    '<div style="flex:1;min-width:0;"><div class="modal-title">Manage Invites</div><div class="modal-subtitle">View and manage student invites</div></div>' +
    '<button type="button" class="modal-close-btn" aria-label="Close">&times;</button>';
  header.querySelector('.modal-close-btn').addEventListener('click', function(){ overlay.remove(); });
  box.appendChild(header);

  var body = document.createElement('div');
  body.className = 'modal-body-scrollable';
  body.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Loading invites...</div>';
  box.appendChild(body);
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  // Load invites
  db.collection(INVITES_COL).orderBy('createdAt', 'desc').get()
    .then(function(snap){
      var invites = [];
      snap.forEach(function(doc){ invites.push({ id: doc.id, data: doc.data() }); });

      var html = '<button type="button" class="btn btn-primary btn-full">+ Create New Invite</button>';
      html += '<div class="invite-table">';
      html += '<div class="invite-table-header"><div>Email</div><div>Status</div><div>Created</div><div>Actions</div></div>';

      if (!invites.length) {
        html += '<div style="text-align:center;padding:40px;color:#999;">No invites yet.</div>';
      } else {
        invites.forEach(function(inv){
          var d = inv.data;
          var link = CREATE_ACCOUNT_URL_BASE + encodeURIComponent(d.token || '');
          var statusClass = (d.status === 'used') ? 'invite-status-used' : 'invite-status-pending';

          html += '<div class="invite-table-row">';
          html += '<div class="invite-email">' + escapeHtml(d.email || 'No email') + '</div>';
          html += '<div><span class="invite-status ' + statusClass + '">' + escapeHtml(d.status || 'pending') + '</span></div>';
          html += '<div class="invite-date">' + formatDateOnly(d.createdAt) + '</div>';
          html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
          html += '<button type="button" class="btn btn-action copy-invite-btn" data-link="' + escapeHtml(link) + '">Copy Link</button>';
          html += '<button type="button" class="btn btn-danger" data-id="' + inv.id + '">Remove</button>';
          html += '</div>';
          html += '</div>';
        });
      }

      html += '</div>';
      body.innerHTML = html;

      // Bind copy buttons
      body.querySelectorAll('.copy-invite-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          var link = btn.getAttribute('data-link');
          copyText(link).then(function(){
            if (window.VaultErrors) window.VaultErrors.success('Invite link copied!');
            else alert('Link copied!');
          }).catch(function(e){
            if (window.VaultErrors) window.VaultErrors.handle(e, 'Copy Invite Link');
            else alert('Failed to copy link');
          });
        });
      });

      // Bind remove buttons
      body.querySelectorAll('.btn-danger').forEach(function(btn){
        btn.addEventListener('click', function(){
          var inviteId = btn.getAttribute('data-id');
          if (!confirm('Are you sure you want to remove this invite?')) return;
          
          db.collection(INVITES_COL).doc(inviteId).delete()
            .then(function(){
              if (window.VaultErrors) window.VaultErrors.success('Invite removed');
              openInvitesModal(db); // Refresh the modal
              overlay.remove();
            })
            .catch(function(e){
              if (window.VaultErrors) window.VaultErrors.handle(e, 'Remove Invite');
              else alert('Error: ' + (e.message || e));
            });
        });
      });

      // Bind create button
      body.querySelector('.btn-primary').addEventListener('click', function(){ overlay.remove(); openAddUserModal(db); });

    }).catch(function(e){
      body.innerHTML = '<div class="error-message">Error loading invites: ' + escapeHtml(e.message || e) + '</div>';
    });
}

// Progress Modal - IMPROVED VERSION with tabs and collapsible courses
function openProgressModal(db, uid, displayName){
  var overlay = makeOverlay();
  var box = document.createElement('div');
  box.className = 'modal-box modal-box-wide modal-box-full-height';
  pvApplyFontFromBase(box);

  var header = document.createElement('div');
  header.className = 'modal-header';
  header.innerHTML =
    '<div style="flex:1;min-width:0;">' +
      '<div class="modal-title">' + escapeHtml(displayName || 'Student') + ' - Course Progress</div>' +
      '<div class="modal-subtitle">Click courses to expand and view lessons</div>' +
    '</div>' +
    '<button type="button" class="modal-close-btn" aria-label="Close">&times;</button>';
  header.querySelector('.modal-close-btn').addEventListener('click', function(){ overlay.remove(); });
  box.appendChild(header);

  // Search box
  var searchContainer = document.createElement('div');
  searchContainer.className = 'progress-search';
  searchContainer.innerHTML = '<input type="text" class="search-input" placeholder="Search courses...">';
  box.appendChild(searchContainer);

  // Pathway tabs
  var tabsNav = document.createElement('div');
  tabsNav.className = 'pathway-tabs';
  tabsNav.innerHTML = 
    '<button class="pathway-tab active" data-pathway="gs">GS <span class="pathway-badge">0</span></button>' +
    '<button class="pathway-tab" data-pathway="fs">FS <span class="pathway-badge">0</span></button>' +
    '<button class="pathway-tab" data-pathway="ss">SS <span class="pathway-badge">0</span></button>' +
    '<button class="pathway-tab" data-pathway="ks">KS <span class="pathway-badge">0</span></button>' +
    '<button class="pathway-tab" data-pathway="rs">RS <span class="pathway-badge">0</span></button>';
  box.appendChild(tabsNav);

  var body = document.createElement('div');
  body.className = 'modal-body-scrollable';
  body.style.padding = '0';
  body.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Loading progress...</div>';
  box.appendChild(body);
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  // Load progress - EXACT SAME Firebase operations as before
  db.collection('users').doc(uid).collection('progress').get()
    .then(function(snap){
      var allProgress = {};
      snap.forEach(function(doc){ allProgress[doc.id] = doc.data(); });

      var COURSES = window.VAULT_COURSES || {};
      
      // Organize courses by pathway
      var pathwayCourses = { gs: [], fs: [], ss: [], ks: [], rs: [] };
      var pathwayCounts = { gs: 0, fs: 0, ss: 0, ks: 0, rs: 0 };

      for (var courseId in COURSES) {
        var course = COURSES[courseId];
        if (!course.lessons || !course.lessons.length) continue;
        
        var pathway = course.pathway || 'gs';
        pathwayCourses[pathway].push({ courseId: courseId, course: course });
        pathwayCounts[pathway]++;
      }

      // Update pathway badges
      tabsNav.querySelectorAll('.pathway-tab').forEach(function(tab){
        var pathway = tab.getAttribute('data-pathway');
        var badge = tab.querySelector('.pathway-badge');
        if (badge) badge.textContent = pathwayCounts[pathway];
      });

      // Create pathway content divs
      var html = '';
      for (var pathway in pathwayCourses) {
        var courses = pathwayCourses[pathway];
        var isActive = pathway === 'gs' ? ' active' : '';
        
        html += '<div id="' + pathway + '-content" class="pathway-content' + isActive + '">';
        
        if (courses.length === 0) {
          html += '<div class="empty-state">';
          html += '<div class="empty-state-icon">ü•Å</div>';
          html += '<div style="font-size:16px;color:#666;font-weight:500;">No courses in this pathway yet</div>';
          html += '</div>';
        } else {
          courses.forEach(function(courseObj){
            var courseId = courseObj.courseId;
            var course = courseObj.course;
            
            var prog = allProgress[courseId] || {};
            var completedRaw = prog.completed || [];
            var completed = [];

            // EXACT SAME normalization logic as before
            if (Array.isArray(completedRaw)) {
              completed = completedRaw;
            } else if (typeof completedRaw === 'object' && completedRaw !== null) {
              for (var k in completedRaw) {
                if (completedRaw[k] === true) completed.push(k);
              }
            }

            var total = course.lessons.length;
            var completedCount = 0;
            course.lessons.forEach(function(lessonId){
              if (completed.indexOf(lessonId) !== -1) completedCount++;
            });

            var pct = total > 0 ? Math.round((completedCount / total) * 100) : 0;
            var levelBadge = (course.levels || []).join(' ‚Ä¢ ').toUpperCase();

            html += '<div class="course-section" data-course-name="' + escapeHtml(course.topic || courseId) + '">';
            
            // Course header (clickable to expand/collapse)
            html += '<div class="course-header">';
            html += '<div class="course-info">';
            html += '<div class="course-name">' + escapeHtml(course.topic || courseId) + '</div>';
            html += '<div class="course-meta">';
            if (levelBadge) html += '<span class="course-level">' + escapeHtml(levelBadge) + '</span>';
            html += '<span class="course-stats">' + completedCount + '/' + total + ' complete</span>';
            html += '</div>';
            html += '</div>';
            html += '<div class="course-arrow">‚ñº</div>';
            html += '</div>';
            
            // Progress bar
            html += '<div class="course-progress-bar"><div class="course-progress-fill" style="width:' + pct + '%"></div></div>';
            
            // Collapsible lesson grid
            html += '<div class="course-lessons">';
            html += '<div class="lesson-grid">';
            course.lessons.forEach(function(lessonId){
              var isComplete = completed.indexOf(lessonId) !== -1;
              html += '<div class="lesson-item' + (isComplete ? ' completed' : '') + '" data-course="' + escapeHtml(courseId) + '" data-lesson="' + escapeHtml(lessonId) + '" data-uid="' + escapeHtml(uid) + '">';
              html += '<span class="lesson-id">' + escapeHtml(lessonId) + '</span>';
              html += '<span class="lesson-toggle' + (isComplete ? ' completed' : '') + '">' + (isComplete ? '‚úì' : '') + '</span>';
              html += '</div>';
            });
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
          });
        }
        
        html += '</div>';
      }

      body.innerHTML = html;

      // Bind tab switching
      tabsNav.querySelectorAll('.pathway-tab').forEach(function(tab){
        tab.addEventListener('click', function(){
          var pathway = tab.getAttribute('data-pathway');
          
          tabsNav.querySelectorAll('.pathway-tab').forEach(function(t){ t.classList.remove('active'); });
          tab.classList.add('active');
          
          body.querySelectorAll('.pathway-content').forEach(function(content){
            content.classList.remove('active');
          });
          body.querySelector('#' + pathway + '-content').classList.add('active');
        });
      });

      // Bind course expansion
      body.querySelectorAll('.course-header').forEach(function(header){
        header.addEventListener('click', function(){
          var section = header.closest('.course-section');
          section.classList.toggle('expanded');
        });
      });

      // Bind search
      var searchInput = searchContainer.querySelector('.search-input');
      searchInput.addEventListener('input', function(e){
        var query = e.target.value.toLowerCase();
        body.querySelectorAll('.course-section').forEach(function(section){
          var courseName = section.getAttribute('data-course-name').toLowerCase();
          section.style.display = courseName.includes(query) || query === '' ? 'block' : 'none';
        });
      });

      // Bind lesson toggles - EXACT SAME Firebase operations as before
      body.querySelectorAll('.lesson-item').forEach(function(item){
        item.addEventListener('click', function(){
          var courseId = item.getAttribute('data-course');
          var lessonId = item.getAttribute('data-lesson');
          var uid = item.getAttribute('data-uid');
          var toggle = item.querySelector('.lesson-toggle');
          var isComplete = toggle.classList.contains('completed');

          var progressRef = db.collection('users').doc(uid).collection('progress').doc(courseId);

          progressRef.get().then(function(doc){
            var data = doc.exists ? (doc.data() || {}) : {};
            var completedRaw = data.completed || [];
            var completed = [];

            // EXACT SAME normalization logic as before
            if (Array.isArray(completedRaw)) {
              completed = completedRaw;
            } else if (typeof completedRaw === 'object' && completedRaw !== null) {
              for (var k in completedRaw) {
                if (completedRaw[k] === true) completed.push(k);
              }
            }

            if (isComplete) {
              completed = completed.filter(function(id){ return id !== lessonId; });
            } else {
              if (completed.indexOf(lessonId) === -1) completed.push(lessonId);
            }

            // EXACT SAME Firebase write as before
            return progressRef.set({ completed: completed }, { merge: true });
          }).then(function(){
            toggle.classList.toggle('completed');
            item.classList.toggle('completed');
            toggle.textContent = toggle.classList.contains('completed') ? '‚úì' : '';

            // Update progress bar
            var section = item.closest('.course-section');
            var allLessons = section.querySelectorAll('.lesson-toggle');
            var completedLessons = section.querySelectorAll('.lesson-toggle.completed');
            var pct = allLessons.length > 0 ? Math.round((completedLessons.length / allLessons.length) * 100) : 0;
            var fillBar = section.querySelector('.course-progress-fill');
            if (fillBar) fillBar.style.width = pct + '%';

            var statEl = section.querySelector('.course-stats');
            if (statEl) statEl.textContent = completedLessons.length + '/' + allLessons.length + ' complete';
          }).catch(function(e){
            if (window.VaultErrors) window.VaultErrors.handle(e, 'Toggle Progress');
            else alert('Error: ' + (e.message || e));
          });
        });
      });
    }).catch(function(e){
      body.innerHTML = '<div class="error-message">Error loading progress: ' + escapeHtml(e.message || e) + '</div>';
    });
}

// Save user changes
function saveUserChanges(uid, accordionEl){
  var firstName = (accordionEl.querySelector('.edit-firstname').value || '').trim();
  var lastName = (accordionEl.querySelector('.edit-lastname').value || '').trim();
  var displayName = (accordionEl.querySelector('.edit-displayname').value || '').trim();
  var ageConfirmed = accordionEl.querySelector('.edit-age-confirmed').checked;
  var selfProgress = accordionEl.querySelector('.edit-self-progress').checked;

  var updates = {
    firstName: firstName,
    lastName: lastName,
    displayName: displayName,
    ageConfirmed: ageConfirmed,
    selfProgress: selfProgress
  };

  db.collection('users').doc(uid).set(updates, { merge: true })
    .then(function(){
      if (window.VaultErrors) window.VaultErrors.success('Changes saved!');
      else alert('Changes saved!');
    })
    .catch(function(e){
      if (window.VaultErrors) window.VaultErrors.handle(e, 'Save Changes');
      else alert('Error: ' + (e.message || e));
    });
}

function pvIsAdmin(user){
  if (!user) return Promise.resolve(false);
  return db.collection('admins').doc(user.uid).get()
    .then(function(doc){ return doc.exists; })
    .catch(function(){ return false; });
}

var ONLINE_WINDOW_MS = 5 * 60 * 1000;

function bindHandlers(){
  // Accordion toggles
  studentsTabEl.querySelectorAll('.user-item').forEach(function(item){
    var header = item.querySelector('.user-item-header');
    var accordion = item.querySelector('.user-accordion');
    var arrow = header.querySelector('.user-meta div');

    header.addEventListener('click', function(e){
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;

      var isExpanded = accordion.classList.contains('expanded');
      accordion.classList.toggle('expanded');
      arrow.textContent = isExpanded ? '‚ñº' : '‚ñ≤';
    });
  });

  // Save Changes buttons
  studentsTabEl.querySelectorAll('.save-changes-btn').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.stopPropagation();
      var uid = btn.getAttribute('data-uid');
      var accordionEl = btn.closest('.user-item');
      saveUserChanges(uid, accordionEl);
    });
  });

  // View Progress buttons
  studentsTabEl.querySelectorAll('.view-progress-btn').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.stopPropagation();
      var uid = btn.getAttribute('data-uid');
      var displayName = btn.getAttribute('data-name');
      openProgressModal(db, uid, displayName);
    });
  });

  var refreshBtn = studentsTabEl.querySelector('#pv-refresh-btn');
  if (refreshBtn) refreshBtn.addEventListener('click', function(){ 
    loadOnce().catch(function(e){ 
      if (window.VaultErrors) window.VaultErrors.handle(e, 'Refresh'); 
    }); 
  });
}

// Render students tab
function render(users){
  var nowMs = Date.now();

  var online = users.filter(function(u){
    return (nowMs - tsToMs(u.lastActive)) <= ONLINE_WINDOW_MS;
  }).sort(function(a,b){ return tsToMs(b.lastActive) - tsToMs(a.lastActive); });

  var html = '';

  // Student List section with accordion
  html += '<div class="admin-section">';
  html += '<div class="admin-section-header">' +
            '<div class="admin-section-title">Student Management <span class="admin-section-count">(' + users.length + ')</span></div>' +
            '<button id="pv-refresh-btn" class="btn btn-icon" title="Refresh">‚Üª</button>' +
          '</div>';

  html += '<div style="padding:12px;">';

  if (!users.length) {
    html += '<div class="empty-message">No students yet.</div>';
  } else {
    users.forEach(function(u){
      var isOnline = (nowMs - tsToMs(u.lastActive)) <= ONLINE_WINDOW_MS;
      var activityDot = statusDot(u.lastActive, u.joinedAt);
      
      var statusText = isOnline ? 'Online' : 'Offline';
      var onlineStyle = isOnline ? 'color:#10b981;font-weight:500;' : 'color:#999;font-weight:normal;';
      var onlineEmoji = isOnline ? 'üü¢ ' : '';

      html += '<div class="user-item">';
      
      // User Header (collapsed view)
      html += '<div class="user-item-header">';
      html += '<div style="flex:1;min-width:0;">';
      html += '<div class="user-name">' + escapeHtml(u.fullName || u.displayName || 'No name') + ' <span style="' + onlineStyle + 'font-size:var(--text-small);">| ' + onlineEmoji + statusText + '</span></div>';
      // Show last seen (with login fallback)
      var lastActiveDisplay = u.lastActive ? formatTsNoYear(u.lastActive) : formatTsNoYear(u.lastLogin);
      html += '<div class="user-email">' + escapeHtml(u.email) + ' ‚Ä¢ Last seen: ' + lastActiveDisplay + '</div>';
      html += '</div>';
      html += '<div class="user-meta">';
      html += '<div style="font-size:18px;">‚ñº</div>';
      html += '</div>';
      html += '</div>';

      // User Accordion Body (expanded view)
      html += '<div class="user-accordion">';
      html += '<div class="accordion-content">';
      
      // Practice Statistics
      html += '<div class="accordion-section">';
      html += '<div class="accordion-section-title">Practice Statistics</div>';
      html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">';
      html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
      html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Last Seen</div>';
      var detailedTimestamp = u.lastActive ? formatTs(u.lastActive) : formatTs(u.lastLogin);
      html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + detailedTimestamp + ' ' + activityDot + '</div>';
      html += '</div>';
      html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
      html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Login Count</div>';
      html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + (u.loginCount || 0) + ' times</div>';
      html += '</div>';
      html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
      html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Avg Session</div>';
      html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + formatAvgTime(u.totalSeconds, u.loginCount) + '</div>';
      html += '</div>';
      html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
      html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Total Practice</div>';
      html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + formatDuration(u.totalSeconds) + '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';

      // Profile Information
      html += '<div class="accordion-section">';
      html += '<div class="accordion-section-title">Profile Information</div>';
      html += '<div class="accordion-row">';
      html += '<div class="accordion-field">';
      html += '<label class="form-label">First Name</label>';
      html += '<input type="text" class="edit-firstname form-input" value="' + escapeHtml(u.firstName) + '" placeholder="First name">';
      html += '</div>';
      html += '<div class="accordion-field">';
      html += '<label class="form-label">Last Name</label>';
      html += '<input type="text" class="edit-lastname form-input" value="' + escapeHtml(u.lastName) + '" placeholder="Last name">';
      html += '</div>';
      html += '<div class="accordion-field">';
      html += '<label class="form-label">Display Name</label>';
      html += '<input type="text" class="edit-displayname form-input" value="' + escapeHtml(u.displayName) + '" placeholder="Display name">';
      html += '</div>';
      html += '</div>';
      html += '</div>';

      // Account Permissions
      html += '<div class="accordion-section">';
      html += '<div class="accordion-section-title">Account Permissions</div>';
      html += '<div class="accordion-row">';
      html += '<label class="checkbox-label">';
      html += '<input type="checkbox" class="edit-age-confirmed" ' + (u.ageConfirmed ? 'checked' : '') + '>';
      html += '<span>16+ years old (can access comments)</span>';
      html += '</label>';
      html += '<label class="checkbox-label">';
      html += '<input type="checkbox" class="edit-self-progress" ' + (u.selfProgress ? 'checked' : '') + '>';
      html += '<span>Allow self-progress (can complete lessons)</span>';
      html += '</label>';
      html += '</div>';
      html += '</div>';

      // Action Buttons
      html += '<div class="user-actions">';
      html += '<button class="view-progress-btn btn btn-primary" style="background:#10b981;border-color:#10b981;" data-uid="' + escapeHtml(u.uid) + '" data-name="' + escapeHtml(u.fullName || u.displayName || u.email) + '">View Progress</button>';
      html += '<button class="save-changes-btn btn btn-primary" data-uid="' + escapeHtml(u.uid) + '">Save Changes</button>';
      html += '</div>';

      html += '</div>';
      html += '</div>';

      html += '</div>';
    });
  }

  html += '</div>';
  html += '</div>';

  studentsTabEl.innerHTML = html;

  bindHandlers();
}

// Render invites tab
function renderInvitesTab(){
  var html = '<div class="admin-section">';
  html += '<div class="admin-section-header" style="display:flex;justify-content:space-between;align-items:center;">';
  html += '<div class="admin-section-title">Invite Management</div>';
  html += '<button id="pv-create-invite-btn" class="btn btn-primary" style="width:auto;">+ Create Invite</button>';
  html += '</div>';

  html += '<div style="padding:12px;">';
  html += '<div id="invites-list-container"><div style="text-align:center;padding:40px;color:#999;">Loading invites...</div></div>';
  html += '</div>';
  html += '</div>';

  invitesTabEl.innerHTML = html;

  // Bind create invite button
  var createBtn = invitesTabEl.querySelector('#pv-create-invite-btn');
  if (createBtn) createBtn.addEventListener('click', function(){ openAddUserModal(db); });

  // Load invites
  loadInvites();
}

function loadInvites(){
  var container = invitesTabEl.querySelector('#invites-list-container');
  if (!container) return;

  db.collection(INVITES_COL).orderBy('createdAt', 'desc').get()
    .then(function(snap){
      var invites = [];
      snap.forEach(function(doc){ invites.push({ id: doc.id, data: doc.data() }); });

      var html = '<div class="invite-table">';
      html += '<div class="invite-table-header"><div>Email</div><div>Status</div><div>Created</div><div>Actions</div></div>';

      if (!invites.length) {
        html += '<div style="text-align:center;padding:40px;color:#999;">No invites yet. Click "Create Invite" to add one.</div>';
      } else {
        invites.forEach(function(inv){
          var d = inv.data;
          var link = CREATE_ACCOUNT_URL_BASE + encodeURIComponent(d.token || '');
          var statusClass = (d.status === 'used') ? 'invite-status-used' : 'invite-status-pending';

          html += '<div class="invite-table-row">';
          html += '<div class="invite-email">' + escapeHtml(d.email || 'No email') + '</div>';
          html += '<div><span class="invite-status ' + statusClass + '">' + escapeHtml(d.status || 'pending') + '</span></div>';
          html += '<div class="invite-date">' + formatDateOnly(d.createdAt) + '</div>';
          html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
          html += '<button type="button" class="btn btn-secondary copy-invite-btn" style="padding:6px 12px;font-size:12px;" data-link="' + escapeHtml(link) + '">Copy Link</button>';
          html += '<button type="button" class="btn btn-secondary remove-invite-btn" style="padding:6px 12px;font-size:12px;" data-id="' + inv.id + '">Remove</button>';
          html += '</div>';
          html += '</div>';
        });
      }

      html += '</div>';
      container.innerHTML = html;

      // Bind copy buttons
      container.querySelectorAll('.copy-invite-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          var link = btn.getAttribute('data-link');
          copyText(link).then(function(){
            if (window.VaultErrors) window.VaultErrors.success('Invite link copied!');
            else alert('Link copied!');
          }).catch(function(e){
            if (window.VaultErrors) window.VaultErrors.handle(e, 'Copy Invite Link');
            else alert('Failed to copy link');
          });
        });
      });

      // Bind remove buttons
      container.querySelectorAll('.remove-invite-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          var inviteId = btn.getAttribute('data-id');
          if (!confirm('Are you sure you want to remove this invite?')) return;
          
          db.collection(INVITES_COL).doc(inviteId).delete()
            .then(function(){
              if (window.VaultErrors) window.VaultErrors.success('Invite removed');
              loadInvites(); // Refresh the list
            })
            .catch(function(e){
              if (window.VaultErrors) window.VaultErrors.handle(e, 'Remove Invite');
              else alert('Error: ' + (e.message || e));
            });
        });
      });

    }).catch(function(e){
      container.innerHTML = '<div class="error-message">Error loading invites: ' + escapeHtml(e.message || e) + '</div>';
    });
}

function loadOnce(){
  return Promise.all([
    db.collection('users').get(),
    db.collection('admins').get()
  ]).then(function(results){
    var usersSnap = results[0];
    var adminSnap = results[1];
    
    var adminUids = {};
    adminSnap.forEach(function(doc){ adminUids[doc.id] = true; });
    
    var users = [];
    usersSnap.forEach(function(d){
      var data = d.data() || {};
      
      if (adminUids[d.id]) return;
      
      users.push({
        uid: d.id,
        email: data.email || '',
        firstName: data.firstName || '',
        lastName: data.lastName || '',
        displayName: data.displayName || '',
        ageConfirmed: data.ageConfirmed === true,
        selfProgress: data.selfProgress === true,
        joinedAt: data.createdAt || null,
        fullName: (data.firstName && data.lastName) ? (data.firstName + ' ' + data.lastName).trim() : (data.displayName || '-')
      });
    });

    var statGets = users.map(function(u){
      return db.collection('users').doc(u.uid).collection('metrics').doc('stats').get()
        .then(function(s){ return { uid: u.uid, data: (s.exists ? (s.data() || {}) : {}) }; });
    });

    var practiceGets = users.map(function(u){
      return db.collection('users').doc(u.uid).collection('practice').doc('stats').get()
        .then(function(s){ return { uid: u.uid, data: (s.exists ? (s.data() || {}) : {}) }; });
    });

   return Promise.all([Promise.all(statGets), Promise.all(practiceGets)]).then(function(res){
var statsArr = res[0];
var practiceArr = res[1];

      var statsByUid = {};
statsArr.forEach(function(x){ statsByUid[x.uid] = x.data || {}; });

var practiceByUid = {};
practiceArr.forEach(function(x){ practiceByUid[x.uid] = x.data || {}; });

users.forEach(function(u){
var st = statsByUid[u.uid] || {};
var pr = practiceByUid[u.uid] || {};

u.lastLogin = st.lastLoginAt || null;
u.lastActive = st.lastSeenAt || st.lastLoginAt || null;
u.lastDeviceType = st.lastDeviceType || '';
u.lastDeviceEmoji = st.lastDeviceEmoji || '';
u.loginCount = (typeof st.loginCount === 'number') ? st.loginCount : 0;
u.totalSeconds = (typeof pr.totalSeconds === 'number') ? pr.totalSeconds : 0;
});

     users.sort(function(a, b) {
       return (tsToMs(b.lastActive) || 0) - (tsToMs(a.lastActive) || 0);
     });

      render(users);
    });
  }).catch(function(e){
    console.error(e);
    if (window.VaultErrors) {
      window.VaultErrors.handle(e, 'Load Admin Data');
    } else {
      alert('Load error: ' + (e && e.message || e));
    }
  });
}

// Tab switching
function initTabs(){
  var tabBtns = document.querySelectorAll('.tab-btn');
  var tabContents = document.querySelectorAll('.tab-content');

  tabBtns.forEach(function(btn){
    btn.addEventListener('click', function(){
      var tabName = btn.getAttribute('data-tab');
      
      // Update active tab button
      tabBtns.forEach(function(b){ b.classList.remove('active'); });
      btn.classList.add('active');
      
      // Update active tab content
      tabContents.forEach(function(content){
        content.classList.remove('active');
      });
      document.getElementById(tabName + '-tab').classList.add('active');
    });
  });
}

// Initialize
function init(){
  try {
    db = firebase.firestore();
    auth = firebase.auth();
    studentsTabEl = document.getElementById('students-tab');
    invitesTabEl = document.getElementById('invites-tab');

    initTabs();
    renderInvitesTab();

    auth.onAuthStateChanged(function(user){
      showBody();

      if (!user) {
        window.location.href = '/login';
        return;
      }

      pvIsAdmin(user).then(function(ok){
        if (!ok) {
          window.location.href = '/';
          return;
        }

        loadOnce().catch(function(e){
          if (studentsTabEl) studentsTabEl.textContent = (e && e.message) ? e.message : 'Error loading admin data.';
        });
      });
    });
  } catch (e) {
    console.error('[Admin Init Error]', e);
    if (window.VaultErrors) {
      window.VaultErrors.handle(e, 'Admin Init');
    }
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

})();
  </script>

</body>
</html>
