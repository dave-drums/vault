<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Console - Practice Vault</title>
  <link rel="icon" type="image/webp" href="/assets/favicon.ico">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Typography Variables -->
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/core.css">
  <link rel="stylesheet" href="/css/admin.css">
  
  <!-- Firebase -->
  <script src="/firebase/firebase-app-compat.js"></script>
  <script src="/firebase/firebase-auth-compat.js"></script>
  <script src="/firebase/firebase-firestore-compat.js"></script>
  <script src="/firebase/firebase-init.js"></script>
  
  <!-- Mark page as protected (requires login + admin) -->
  <script>document.documentElement.dataset.protected = 'true';</script>
  <script src="/config/auth-guard.js"></script>
  
  <!-- Error Handler for Toast notifications -->
  <script src="/config/error-handler.js"></script>
  
  <!-- Components for Toast notifications -->
  <script src="/config/components.js"></script>
  <script src="/config/navigation.js"></script>
  
</head>
<body>
  <div id="page-loader" class="page-loader">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- Hero Section -->
<div class="hero">
  <div class="hero-banner" data-bg="home"></div>
  <div class="hero-content">
    <h1 class="hero-title">Admin Dashboard</h1>
    <div class="hero-badge">Management Console</div>
  </div>
</div>
  
  <!-- Main Container -->
  <div class="admin-container">
    <div id="vault-admin-root"></div>
  </div>
  
  <!-- Admin Console Logic -->
  <script src="/config/course-data.js"></script>
  <script>
(function(){
var db;
var auth;
var rootEl;

// Load course configuration from shared file
// This ensures consistency across all pages
(function() {
  if (window.VAULT_COURSES) return; // Already loaded
  
  var script = document.createElement('script');
  script.src = 'course-data.js';
  script.async = false; // Synchronous to ensure it's loaded before console code runs
  document.head.appendChild(script);
})();

function pvGetFontBaseEl(){
  return (
    document.querySelector('.sqs-block-content') ||
    document.querySelector('.sqs-layout') ||
    document.getElementById('vault-admin-root') ||
    document.body
  );
}
function pvApplyFontFromBase(el){
  var baseEl = pvGetFontBaseEl();
  var cs = window.getComputedStyle(baseEl);
  if (cs.font && cs.font !== 'normal') el.style.font = cs.font;
  el.style.fontFamily = cs.fontFamily;
  el.style.fontSize = cs.fontSize;
  el.style.fontWeight = cs.fontWeight;
  el.style.lineHeight = cs.lineHeight;
  el.style.color = cs.color;
}

function escapeHtml(s){
  return String(s || '').replace(/[&<>"']/g, function (c) {
    return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c];
  });
}
function tsToMs(ts){
  if (!ts || !ts.toDate) return 0;
  try { return ts.toDate().getTime(); } catch (e) { return 0; }
}
function formatTs(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleString('en-AU', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Australia/Brisbane'
  });
}
function formatTsNoYear(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleString('en-AU', {
    day: 'numeric',
    month: 'short',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Australia/Brisbane'
  });
}
function formatDateOnly(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleDateString('en-AU', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    timeZone: 'Australia/Brisbane'
  });
}
function formatDuration(sec){
  sec = Number(sec || 0);
  if (sec <= 0) return '0 min';
  var mins = Math.round(sec / 60);
  if (mins < 60) return mins + ' min';
  var hours = Math.floor(mins / 60);
  var rem = mins % 60;
  return rem === 0 ? hours + ' hrs' : hours + ' hrs ' + rem + ' min';
}
function formatAvgTime(totalSeconds, loginCount){
  totalSeconds = Number(totalSeconds || 0);
  loginCount = Number(loginCount || 0);
  if (totalSeconds <= 0 || loginCount <= 0) return '0 min';
  return formatDuration(Math.round(totalSeconds / loginCount));
}
function statusDot(lastLoginTs, joinedAtTs){
  var ms = tsToMs(lastLoginTs);
  if (!ms) ms = tsToMs(joinedAtTs);
  if (!ms) return 'ðŸ”´';
  var days = (Date.now() - ms) / (1000 * 60 * 60 * 24);
  if (days < 14) return 'ðŸŸ¢';
  if (days < 30) return 'ðŸŸ¡';
  return 'ðŸ”´';
}
function formatRelativeTime(ts){
  if (!ts || !ts.toDate) return '';
  var ms = tsToMs(ts);
  if (!ms) return '';
  
  var now = Date.now();
  var diff = now - ms;
  var days = Math.floor(diff / (1000 * 60 * 60 * 24));
  var weeks = Math.floor(days / 7);
  var months = Math.floor(days / 30);
  var years = Math.floor(days / 365);
  
  if (days < 7) return '(' + days + ' day' + (days === 1 ? '' : 's') + ' ago)';
  if (weeks < 4) return '(' + weeks + ' week' + (weeks === 1 ? '' : 's') + ' ago)';
  if (months < 12) return '(' + months + ' month' + (months === 1 ? '' : 's') + ' ago)';
  
  var remainingMonths = months - (years * 12);
  if (remainingMonths === 0) return '(' + years + ' year' + (years === 1 ? '' : 's') + ' ago)';
  return '(' + years + ' year' + (years === 1 ? '' : 's') + ', ' + remainingMonths + ' month' + (remainingMonths === 1 ? '' : 's') + ' ago)';
}
function copyText(text){
  if (navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text);
  }
  return new Promise(function (resolve, reject) {
    try {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      var ok = document.execCommand('copy');
      document.body.removeChild(ta);
      ok ? resolve() : reject();
    } catch (e) { reject(e); }
  });
}
function showBody(){
  if (document.body) document.body.style.opacity = '1';
}

var INVITES_COL = 'invites';
var CREATE_ACCOUNT_URL_BASE = 'https://vault.davedrums.com.au/create-account?t=';

function randomToken(len){
  len = len || 16;
  try {
    var bytes = new Uint8Array(len);
    (window.crypto || window.msCrypto).getRandomValues(bytes);
    var out = '';
    for (var i = 0; i < bytes.length; i++) out += ('0' + bytes[i].toString(16)).slice(-2);
    return out;
  } catch (e) {
    return (Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2) + Date.now().toString(16)).slice(0, len * 2);
  }
}

function makeOverlay(){
  var overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.setAttribute('role','dialog');
  overlay.setAttribute('aria-modal','true');
  overlay.addEventListener('click', function(e){ if (e.target === overlay) overlay.remove(); });
  return overlay;
}

// NEW: Add User Modal with two-step process
function openAddUserModal(db){
  var overlay = makeOverlay();

  var box = document.createElement('div');
  box.className = 'modal-box';

  var headerHtml = 
    '<div class="modal-header">' +
      '<div>' +
        '<div class="modal-title">Add User</div>' +
        '<div class="modal-subtitle">Create an invite link (7-day expiry)</div>' +
      '</div>' +
      '<button id="modal-close-btn" class="modal-close-btn">&times;</button>' +
    '</div>';

  var step1Html = 
    '<div id="email-step" class="step-container">' +
      '<div class="form-group">' +
        '<label class="form-label">Email Address</label>' +
        '<input type="email" id="invite-email" placeholder="user@example.com" class="form-input">' +
      '</div>' +
      '<div class="button-group">' +
        '<button id="invite-close" class="btn btn-secondary">Close</button>' +
        '<button id="invite-create" class="btn btn-primary">Create Invite</button>' +
      '</div>' +
    '</div>';

  var step2Html = 
    '<div id="invite-link-step" class="step-container hidden">' +
      '<div class="success-message">' +
        '<div class="success-icon">âœ“</div>' +
        '<div class="success-text">Invite Created Successfully</div>' +
      '</div>' +
      '<div class="form-group">' +
        '<label class="form-label">Invite Link</label>' +
        '<textarea id="invite-url" readonly class="form-textarea"></textarea>' +
      '</div>' +
      '<div class="form-help-text">Link expires in 7 days</div>' +
      '<button id="copy-invite" class="btn btn-primary btn-full">ðŸ“‹ Copy Link</button>' +
      '<button id="reset-modal" class="btn btn-secondary btn-full">Close</button>' +
    '</div>';

  box.innerHTML = headerHtml + step1Html + step2Html;
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  function close(){ overlay.remove(); }
  
  box.querySelector('#modal-close-btn').addEventListener('click', close);
  box.querySelector('#invite-close').addEventListener('click', close);

  var emailInput = box.querySelector('#invite-email');
  var createBtn = box.querySelector('#invite-create');
  var step1 = box.querySelector('#email-step');
  var step2 = box.querySelector('#invite-link-step');
  var urlTextarea = box.querySelector('#invite-url');

  function resetModal(){
    step1.classList.remove('hidden');
    step2.classList.add('hidden');
    emailInput.value = '';
  }

  box.querySelector('#reset-modal').addEventListener('click', close);

  createBtn.addEventListener('click', function(){
    var email = (emailInput.value || '').trim().toLowerCase();
    if (!email) {
      if (window.VaultErrors) window.VaultErrors.info('Please enter an email address');
      return;
    }

    createBtn.disabled = true;
    createBtn.textContent = 'Creating...';

    var token = randomToken(16);
    var expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    
    db.collection(INVITES_COL).doc(token).set({
      email: email,
      used: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      expiresAt: firebase.firestore.Timestamp.fromDate(expires)
    }).then(function(){
      var link = CREATE_ACCOUNT_URL_BASE + token;
      
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
      urlTextarea.value = link;
      
      createBtn.disabled = false;
      createBtn.textContent = 'Create Invite';
    }).catch(function(err){
      createBtn.disabled = false;
      createBtn.textContent = 'Create Invite';
      if (window.VaultErrors) {
        window.VaultErrors.handle(err, 'Create Invite');
      } else {
        alert('Failed to create invite');
      }
    });
  });

  box.querySelector('#copy-invite').addEventListener('click', function(){
    copyText(urlTextarea.value).then(function(){
      if (window.VaultErrors) {
        window.VaultErrors.success('Invite link copied!');
      }
    }).catch(function(){
      if (window.VaultErrors) {
        window.VaultErrors.info('Failed to copy link');
      }
    });
  });
}

// NEW: Invites Modal with revoke for all invites
function openInvitesModal(db){
  var overlay = makeOverlay();

  var box = document.createElement('div');
  box.className = 'modal-box modal-box-wide modal-box-full-height';

  box.innerHTML =
    '<div class="modal-header">' +
      '<div>' +
        '<div class="modal-title">Invitation Links</div>' +
        '<div class="modal-subtitle">Manage user invitations</div>' +
      '</div>' +
      '<button id="invites-close" class="modal-close-btn">&times;</button>' +
    '</div>' +
    '<div id="invites-list-container" class="modal-body-scrollable"></div>';

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  function close(){ overlay.remove(); }
  box.querySelector('#invites-close').addEventListener('click', close);

  var listContainer = box.querySelector('#invites-list-container');
  listContainer.innerHTML = '<div class="empty-message">Loading...</div>';

  db.collection(INVITES_COL).orderBy('createdAt', 'desc').limit(100).get()
    .then(function(snap){
      if (snap.empty) {
        listContainer.innerHTML = '<div class="empty-message">No invites yet.</div>';
        return;
      }

      var tableHtml = 
        '<div class="invite-table">' +
          '<div class="invite-table-header" style="grid-template-columns:2fr 1fr 1.5fr 1.5fr 1fr;">' +
            '<div>Email</div>' +
            '<div>Status</div>' +
            '<div>Created</div>' +
            '<div>Expires</div>' +
            '<div>Action</div>' +
          '</div>';

      snap.forEach(function(doc){
        var d = doc.data();
        var email = d.email || '-';
        var used = d.used === true;
        var createdAt = d.createdAt ? formatDateOnly(d.createdAt) : '-';
        var expiresAt = d.expiresAt ? formatDateOnly(d.expiresAt) : '-';
        
        var now = Date.now();
        var expiryMs = tsToMs(d.expiresAt);
        var isExpired = expiryMs > 0 && now > expiryMs;

        var statusClass, statusText;
        if (used) {
          statusClass = 'invite-status-used';
          statusText = 'Used';
        } else if (isExpired) {
          statusClass = 'invite-status-pending'; // Reuse pending style for expired
          statusText = 'Expired';
        } else {
          statusClass = 'invite-status-pending';
          statusText = 'Active';
        }

        var opacity = (used || isExpired) ? '0.6' : '1';

        tableHtml += 
          '<div class="invite-table-row" style="grid-template-columns:2fr 1fr 1.5fr 1.5fr 1fr;opacity:' + opacity + ';">' +
            '<div class="invite-email">' + escapeHtml(email) + '</div>' +
            '<div><span class="invite-status ' + statusClass + '">' + statusText + '</span></div>' +
            '<div class="invite-date">' + createdAt + '</div>' +
            '<div class="invite-date">' + expiresAt + '</div>' +
            '<div>' +
              (used ? '<span class="invite-placeholder">â€”</span>' : 
                '<button class="revoke-invite-btn btn btn-danger btn-icon" data-invite-id="' + doc.id + '">Revoke</button>') +
            '</div>' +
          '</div>';
      });

      tableHtml += '</div>';
      listContainer.innerHTML = tableHtml;

      listContainer.querySelectorAll('.revoke-invite-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          var inviteId = btn.getAttribute('data-invite-id');
          if (confirm('Revoke this invitation? The link will no longer work.')) {
            db.collection(INVITES_COL).doc(inviteId).delete()
              .then(function(){
                if (window.VaultErrors) {
                  window.VaultErrors.success('Invitation revoked');
                }
                overlay.remove();
                openInvitesModal(db);
              })
              .catch(function(e){
                if (window.VaultErrors) {
                  window.VaultErrors.handle(e, 'Revoke Invite');
                } else {
                  alert('Failed to revoke invite');
                }
              });
          }
        });
      });
    })
    .catch(function(e){
      listContainer.innerHTML = '<div class="error-message">Error loading invites</div>';
      if (window.VaultErrors) {
        window.VaultErrors.handle(e, 'Load Invites');
      }
    });
}

var ONLINE_WINDOW_MS = 3 * 60 * 1000;

document.addEventListener('DOMContentLoaded', function(){
  if (typeof firebase === 'undefined' || !firebase.auth || !firebase.firestore) return;

  auth = firebase.auth();
  db = firebase.firestore();
  rootEl = document.getElementById('vault-admin-root');
  if (!rootEl) return;

  function pvIsAdmin(user){
    if (!user || !user.uid) return Promise.resolve(false);
    return db.collection('admins').doc(user.uid).get()
      .then(function(doc){ return doc.exists; })
      .catch(function(){ return false; });
  }

  // NEW: Inline accordion editing - no separate profile modal
  function saveUserChanges(uid, accordionEl){
    var firstName = accordionEl.querySelector('.edit-firstname').value.trim();
    var lastName = accordionEl.querySelector('.edit-lastname').value.trim();
    var displayName = accordionEl.querySelector('.edit-displayname').value.trim();
    var ageConfirmed = accordionEl.querySelector('.edit-age-confirmed').checked;
    var selfProgress = accordionEl.querySelector('.edit-self-progress').checked;

    var updates = {
      firstName: firstName,
      lastName: lastName,
      displayName: displayName,
      ageConfirmed: ageConfirmed,
      selfProgress: selfProgress
    };

    db.collection('users').doc(uid).set(updates, { merge: true })
      .then(function(){
        if (window.VaultErrors) {
          window.VaultErrors.success('Changes saved');
        }
        loadOnce();
      })
      .catch(function(e){
        if (window.VaultErrors) {
          window.VaultErrors.handle(e, 'Save Changes');
        } else {
          alert('Save failed');
        }
      });
  }

  function openProgressModal(db, uid, displayName){
    var overlay = makeOverlay();

    var box = document.createElement('div');
    box.className = 'modal-box modal-box-wide modal-box-full-height';

    // Modal Header
    var headerHtml = 
      '<div class="modal-header">' +
        '<div>' +
          '<div class="modal-title">Progress Report: ' + escapeHtml(displayName) + '</div>' +
          '<div class="modal-subtitle">View and manage lesson completion</div>' +
        '</div>' +
        '<button id="progress-modal-close" class="modal-close-btn">&times;</button>' +
      '</div>';

    box.innerHTML = headerHtml;
    
    // Modal Body (scrollable)
    var modalBody = document.createElement('div');
    modalBody.className = 'modal-body-scrollable';
    
    // Course sections container (no self-progress, no stats)
    var coursesContainer = document.createElement('div');
    coursesContainer.id = 'progress-courses-container';
    modalBody.appendChild(coursesContainer);
    
    box.appendChild(modalBody);
    
    // Close button handler
    box.querySelector('#progress-modal-close').addEventListener('click', function(){
      overlay.remove();
    });
    
    overlay.appendChild(box);
    document.body.appendChild(overlay);
    
    // Load all progress data
    loadAllProgress(db, uid, coursesContainer);
  }
  
  function loadAllProgress(db, uid, coursesContainer){
    if (!window.VAULT_COURSES) {
      coursesContainer.innerHTML = '<div class="empty-message">No courses available</div>';
      return;
    }
    
    // Get all course IDs that have lessons
    var courseIds = [];
    for (var cId in window.VAULT_COURSES) {
      if (window.VAULT_COURSES[cId].lessons && window.VAULT_COURSES[cId].lessons.length > 0) {
        courseIds.push(cId);
      }
    }
    
    if (courseIds.length === 0) {
      coursesContainer.innerHTML = '<div class="empty-message">No courses with lessons yet</div>';
      return;
    }
    
    // Load progress for all courses
    var progressPromises = courseIds.map(function(courseId){
      return db.collection('users').doc(uid).collection('progress').doc(courseId).get()
        .then(function(snap){
          return {
            courseId: courseId,
            data: snap.exists ? snap.data() : {}
          };
        });
    });
    
    Promise.all(progressPromises).then(function(results){
      var courseProgress = {};
      
      results.forEach(function(result){
        var courseId = result.courseId;
        var courseData = window.VAULT_COURSES[courseId];
        var progressData = result.data;
        var completed = progressData.completed || {};
        
        var lessonCount = courseData.lessons.length;
        var completedCount = 0;
        
var completedArray = window.normalizeCompleted ? window.normalizeCompleted(completed) : (Array.isArray(completed) ? completed : Object.keys(completed).filter(function(k){return completed[k]===true;}));
courseData.lessons.forEach(function(lessonId){
  if (completedArray.indexOf(lessonId) !== -1) {
    completedCount++;
  }
});
        
        courseProgress[courseId] = {
          completed: completedCount,
          total: lessonCount,
          completedLessons: completed
        };
      });
      
      // Render course sections
      var coursesHtml = '';
      
      courseIds.forEach(function(courseId){
        var courseData = window.VAULT_COURSES[courseId];
        var progress = courseProgress[courseId];
        
        var levelBadgeColor = '#e0f2fe';
        var levelTextColor = '#0284c7';
        if (courseData.level.includes('Intermediate')) {
          levelBadgeColor = '#fef3c7';
          levelTextColor = '#d97706';
        } else if (courseData.level.includes('Advanced')) {
          levelBadgeColor = '#fee2e2';
          levelTextColor = '#dc2626';
        }
        
        coursesHtml += '<div class="course-section">';
        
        // Course header
        coursesHtml += '<div class="course-section-header">';
        coursesHtml += '<div class="course-info">';
        coursesHtml += '<div class="course-name">' + escapeHtml(courseData.name) + '</div>';
        coursesHtml += '<div class="course-level-badge" style="background:' + levelBadgeColor + ';color:' + levelTextColor + ';">' + escapeHtml(courseData.level) + '</div>';
        coursesHtml += '</div>';
        coursesHtml += '</div>';
        
        // Lesson grid
        coursesHtml += '<div class="lesson-grid">';
        
        courseData.lessons.forEach(function(lessonId){
var completedArray = window.normalizeCompleted ? window.normalizeCompleted(progress.completedLessons) : (Array.isArray(progress.completedLessons) ? progress.completedLessons : []);
var isCompleted = completedArray.indexOf(lessonId) !== -1;
          var completedClass = isCompleted ? ' completed' : '';
          
          coursesHtml += '<div class="lesson-item' + completedClass + '" data-course="' + courseId + '" data-lesson="' + lessonId + '">';
          coursesHtml += '<span class="lesson-id">' + lessonId + '</span>';
          coursesHtml += '<div class="lesson-toggle' + completedClass + '"></div>';
          coursesHtml += '</div>';
        });
        
        coursesHtml += '</div>';
        coursesHtml += '</div>';
      });
      
      coursesContainer.innerHTML = coursesHtml;
      
// Add click handlers for lesson items
coursesContainer.querySelectorAll('.lesson-item').forEach(function(item){
  item.addEventListener('click', function(){
    var courseId = item.getAttribute('data-course');
    var lessonId = item.getAttribute('data-lesson');
    var isCompleted = item.classList.contains('completed');
    var newState = !isCompleted;
    
    // Update Firestore - use ARRAY format
    var currentProgress = courseProgress[courseId].completedLessons;
    var newCompleted;
    
    if (Array.isArray(currentProgress)) {
      // Array format
      if (newState) {
        newCompleted = currentProgress.concat([lessonId]);
      } else {
        newCompleted = currentProgress.filter(function(id){ return id !== lessonId; });
      }
    } else {
      // Object format - convert to array
      var arr = Object.keys(currentProgress).filter(function(k){ return currentProgress[k] === true; });
      if (newState) {
        newCompleted = arr.concat([lessonId]);
      } else {
        newCompleted = arr.filter(function(id){ return id !== lessonId; });
      }
    }
    
    db.collection('users').doc(uid).collection('progress').doc(courseId)
      .set({
        completed: newCompleted,
        lastLesson: lessonId,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true })
      .then(function(){
        if(window.VaultToast) window.VaultToast.success('Updated: Lesson ' + lessonId);
        loadAllProgress(db, uid, coursesContainer);
      })
      .catch(function(e){
        console.error('Failed to update:', e);
        if(window.VaultToast) {
          window.VaultToast.error('Update failed: ' + e.message);
        }
      });
  });
});
      
    }).catch(function(e){
      console.error('Failed to load progress:', e);
      coursesContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#dc2626;">Error loading progress data</div>';
    });
  }

  function bindHandlers(){
    // Toggle user accordion
    rootEl.querySelectorAll('.user-item-header').forEach(function(header){
      header.addEventListener('click', function(){
        var item = header.closest('.user-item');
        var accordion = item.querySelector('.user-accordion');
        var wasOpen = accordion.classList.contains('expanded');

        // Close all
        rootEl.querySelectorAll('.user-accordion').forEach(function(a){
          a.classList.remove('expanded');
        });

        // Open clicked if wasn't open
        if (!wasOpen) {
          accordion.classList.add('expanded');
        }
      });
    });

    // Save Changes buttons
    rootEl.querySelectorAll('.save-changes-btn').forEach(function(btn){
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        var uid = btn.getAttribute('data-uid');
        var accordionEl = btn.closest('.user-item');
        saveUserChanges(uid, accordionEl);
      });
    });

    // View Progress buttons
    rootEl.querySelectorAll('.view-progress-btn').forEach(function(btn){
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        var uid = btn.getAttribute('data-uid');
        var displayName = btn.getAttribute('data-name');
        openProgressModal(db, uid, displayName);
      });
    });

    var addBtn = rootEl.querySelector('#pv-add-user-btn');
    if (addBtn) addBtn.addEventListener('click', function(){ openAddUserModal(db); });

    var invitesBtn = rootEl.querySelector('#pv-invites-btn');
    if (invitesBtn) invitesBtn.addEventListener('click', function(){ openInvitesModal(db); });

    var refreshBtn = rootEl.querySelector('#pv-refresh-btn');
    if (refreshBtn) refreshBtn.addEventListener('click', function(){ 
      loadOnce().catch(function(e){ 
        if (window.VaultErrors) window.VaultErrors.handle(e, 'Refresh'); 
      }); 
    });
  }

  // NEW: Render accordion layout
  function render(users){
    var nowMs = Date.now();

    var online = users.filter(function(u){
      return (nowMs - tsToMs(u.lastActive)) <= ONLINE_WINDOW_MS;
    }).sort(function(a,b){ return tsToMs(b.lastActive) - tsToMs(a.lastActive); });

    var onlineText = online.length
      ? ('ðŸ¥ ' + online.map(function(u){ return escapeHtml(u.email); }).join(', '))
      : 'No one online right now.';

    var html = '';

    // Student List section with accordion
    html += '<div class="admin-section">';
    html += '<div class="admin-section-header" style="flex-direction:column;align-items:center;gap:16px;">' +
              '<div style="display:flex;align-items:center;gap:12px;">' +
  '<div class="admin-section-title">STUDENT LIST <span class="admin-section-count">(' + users.length + ')</span></div>' +
  '<button id="pv-refresh-btn" class="btn btn-icon" title="Refresh">â†»</button>' +
'</div>' +
              '<div style="display:flex;gap:10px;">' +
                '<button id="pv-invites-btn" class="btn btn-header">Invites</button>' +
                '<button id="pv-add-user-btn" class="btn btn-header btn-header-primary">+ Add User</button>' +
              '</div>' +
            '</div>';

    html += '<div style="padding:12px;">';

    if (!users.length) {
      html += '<div class="empty-message">No students yet.</div>';
    } else {
      users.forEach(function(u){
        var isOnline = (nowMs - tsToMs(u.lastActive)) <= ONLINE_WINDOW_MS;
        var activityDot = statusDot(u.lastLogin, u.joinedAt);
        
        var statusClass = isOnline ? 'status-dot' : 'status-dot-offline';
        var statusText = isOnline ? 'Online' : 'Offline';

        html += '<div class="user-item">';
        
        // User Header (collapsed view)
        html += '<div class="user-item-header">';
        html += '<div style="flex:1;min-width:0;">';
        html += '<div class="user-name">' + escapeHtml(u.fullName || u.displayName || 'No name') + ' <span style="color:#999;font-weight:normal;font-size:var(--text-small);">| ' + statusText + '</span></div>';
        html += '<div class="user-email">' + escapeHtml(u.email) + ' â€¢ Last: ' + formatTsNoYear(u.lastLogin) + '</div>';
        html += '</div>';
        html += '<div class="user-meta">';
        html += '<div style="font-size:18px;">â–¼</div>';
        html += '</div>';
        html += '</div>';

        // User Accordion Body (expanded view)
        html += '<div class="user-accordion">';
        html += '<div class="accordion-content">';
        
        // Practice Statistics
        html += '<div class="accordion-section">';
        html += '<div class="accordion-section-title">Practice Statistics</div>';
        html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Last Login</div>';
        html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + formatTs(u.lastLogin) + ' ' + activityDot + '</div>';
        html += '</div>';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Login Count</div>';
        html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + (u.loginCount || 0) + ' times</div>';
        html += '</div>';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Avg Session</div>';
        html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + formatAvgTime(u.totalSeconds, u.loginCount) + '</div>';
        html += '</div>';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:var(--text-micro);color:#999;text-transform:uppercase;margin-bottom:4px;">Total Practice</div>';
        html += '<div style="font-size:var(--text-small);font-weight:500;color:#1a1a2e;">' + formatDuration(u.totalSeconds) + '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Profile Information
        html += '<div class="accordion-section">';
        html += '<div class="accordion-section-title">Profile Information</div>';
        html += '<div class="accordion-row">';
        html += '<div class="accordion-field">';
        html += '<label class="form-label">First Name</label>';
        html += '<input type="text" class="edit-firstname form-input" value="' + escapeHtml(u.firstName) + '" placeholder="First name">';
        html += '</div>';
        html += '<div class="accordion-field">';
        html += '<label class="form-label">Last Name</label>';
        html += '<input type="text" class="edit-lastname form-input" value="' + escapeHtml(u.lastName) + '" placeholder="Last name">';
        html += '</div>';
        html += '<div class="accordion-field">';
        html += '<label class="form-label">Display Name</label>';
        html += '<input type="text" class="edit-displayname form-input" value="' + escapeHtml(u.displayName) + '" placeholder="Display name">';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Account Permissions
        html += '<div class="accordion-section">';
        html += '<div class="accordion-section-title">Account Permissions</div>';
        html += '<div class="accordion-row">';
        html += '<label class="checkbox-label">';
        html += '<input type="checkbox" class="edit-age-confirmed" ' + (u.ageConfirmed ? 'checked' : '') + '>';
        html += '<span>16+ years old (can access comments)</span>';
        html += '</label>';
        html += '<label class="checkbox-label">';
        html += '<input type="checkbox" class="edit-self-progress" ' + (u.selfProgress ? 'checked' : '') + '>';
        html += '<span>Allow self-progress (can complete lessons)</span>';
        html += '</label>';
        html += '</div>';
        html += '</div>';

        // Action Buttons
        html += '<div class="user-actions">';
        html += '<button class="view-progress-btn btn btn-primary" style="background:#10b981;border-color:#10b981;" data-uid="' + escapeHtml(u.uid) + '" data-name="' + escapeHtml(u.fullName || u.displayName || u.email) + '">View Progress</button>';
        html += '<button class="save-changes-btn btn btn-primary" data-uid="' + escapeHtml(u.uid) + '">Save Changes</button>';
        html += '</div>';

        html += '</div>';
        html += '</div>';

        html += '</div>';
      });
    }

    html += '</div>';
    html += '</div>';

    rootEl.innerHTML = html;

    bindHandlers();
  }

  function loadOnce(){
    return Promise.all([
      db.collection('users').get(),
      db.collection('admins').get()
    ]).then(function(results){
      var usersSnap = results[0];
      var adminSnap = results[1];
      
      var adminUids = {};
      adminSnap.forEach(function(doc){ adminUids[doc.id] = true; });
      
      var users = [];
      usersSnap.forEach(function(d){
        var data = d.data() || {};
        
        if (adminUids[d.id]) return;
        
        users.push({
          uid: d.id,
          email: data.email || '',
          firstName: data.firstName || '',
          lastName: data.lastName || '',
          displayName: data.displayName || '',
          ageConfirmed: data.ageConfirmed === true,
          selfProgress: data.selfProgress === true,
          joinedAt: data.createdAt || null,
          fullName: (data.firstName && data.lastName) ? (data.firstName + ' ' + data.lastName).trim() : (data.displayName || '-')
        });
      });

      var statGets = users.map(function(u){
        return db.collection('users').doc(u.uid).collection('metrics').doc('stats').get()
          .then(function(s){ return { uid: u.uid, data: (s.exists ? (s.data() || {}) : {}) }; });
      });

      // ADD THIS - Load practice stats separately
      var practiceGets = users.map(function(u){
        return db.collection('users').doc(u.uid).collection('practice').doc('stats').get()
          .then(function(s){ return { uid: u.uid, data: (s.exists ? (s.data() || {}) : {}) }; });
      });

     return Promise.all([Promise.all(statGets), Promise.all(practiceGets)]).then(function(res){
  var statsArr = res[0];
  var practiceArr = res[1];

        var statsByUid = {};
statsArr.forEach(function(x){ statsByUid[x.uid] = x.data || {}; });

var practiceByUid = {};
practiceArr.forEach(function(x){ practiceByUid[x.uid] = x.data || {}; });

users.forEach(function(u){
  var st = statsByUid[u.uid] || {};
  var pr = practiceByUid[u.uid] || {};

  u.lastLogin = st.lastLoginAt || null;
  u.lastActive = st.lastSeenAt || st.lastLoginAt || null;
  u.lastDeviceType = st.lastDeviceType || '';
  u.lastDeviceEmoji = st.lastDeviceEmoji || '';
  u.loginCount = (typeof st.loginCount === 'number') ? st.loginCount : 0;
  u.totalSeconds = (typeof pr.totalSeconds === 'number') ? pr.totalSeconds : 0;
});

       users.sort(function(a, b) {
         return (tsToMs(b.lastActive) || 0) - (tsToMs(a.lastActive) || 0);
       });

        render(users);
      });
    }).catch(function(e){
      console.error(e);
      if (window.VaultErrors) {
        window.VaultErrors.handle(e, 'Load Admin Data');
      } else {
        alert('Load error: ' + (e && e.message || e));
      }
    });
  }

  auth.onAuthStateChanged(function(user){
    showBody();

    if (!user) {
      // Not logged in - redirect to login
      window.location.href = '/login';
      return;
    }

    pvIsAdmin(user).then(function(ok){
      if (!ok) {
        // Logged in but not admin - redirect to home
        window.location.href = '/';
        return;
      }

      loadOnce().catch(function(e){
        rootEl.textContent = (e && e.message) ? e.message : 'Error loading admin data.';
      });
      
    });
  });
});
})();
  </script>

</body>
</html>
