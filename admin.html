<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Console - Practice Vault</title>
  <link rel="icon" type="image/webp" href="/assets/favicon.webp">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Typography Variables -->
  <link rel="stylesheet" href="/config/typography.css">
  
  <!-- Firebase -->
  <script src="/firebase/firebase-app-compat.js"></script>
  <script src="/firebase/firebase-auth-compat.js"></script>
  <script src="/firebase/firebase-firestore-compat.js"></script>
  <script src="/firebase/firebase-init.js"></script>
  
  <!-- Mark page as protected (requires login + admin) -->
  <script>document.documentElement.dataset.protected = 'true';</script>
  <script src="/config/auth-guard.js"></script>
  
  <!-- Error Handler for Toast notifications -->
  <script src="/config/error-handler.js"></script>
  
  <!-- Components for Toast notifications -->
  <script src="/config/components.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font-size: 16px;
    }
    
    :root {
      --accent: #06b3fd;
      --text-primary: #1a1a1a;
      --text-secondary: #6c757d;
      --surface: #fff;
      --surface-hover: #f8f9fa;
      --border: #e9ecef;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
/* Hide body until auth checked */
html[data-protected="true"] body {
  opacity: 0;
  transition: opacity 0.3s;
}

body {
  font-family: 'Inter', sans-serif;
  background: #f8f9fa;
  color: var(--text-primary);
  opacity: 0;
  transition: opacity 0.3s;
}

body.auth-checked {
  opacity: 1;
}

/* Auth Loading Screen */
.auth-loading {
  position: fixed;
  inset: 0;
  background: #1a1a2e;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.auth-loading .auth-loading-spinner {
  width: 50px;
  height: 50px;
  border: 4px solid rgba(6, 179, 253, 0.2);
  border-top-color: #06b3fd;
  border-radius: 50%;
  animation: auth-spin 0.8s linear infinite;
}

@keyframes auth-spin {
  to { transform: rotate(360deg); }
}
    
    /* ADMIN HERO HEADER */
    .admin-hero {
      position: relative;
      background: #1a1a2e;
      padding: 100px 20px 80px;
      margin-bottom: 48px;
      overflow: hidden;
    }
    
    .admin-hero:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #06b3fd, #38bdf8, #06b3fd);
      background-size: 200% auto;
      animation: gradient-shift 3s linear infinite;
      z-index: 3;
    }
    
    @keyframes gradient-shift {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }
    
    .admin-hero-bg {
      position: absolute;
      inset: 0;
      background-image: url('/assets/pv-home.webp');
      background-size: cover;
      background-position: center;
      opacity: 0.15;
      z-index: 0;
    }
    
    .admin-hero-bg:after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at top, rgba(6,179,253,0.1) 0%, transparent 50%);
    }
    
    .admin-hero-content {
      position: relative;
      max-width: 1200px;
      margin: 0 auto;
      text-align: center;
      z-index: 1;
    }
    
    .admin-hero-title {
      font-family: 'Oswald', sans-serif;
      font-size: var(--heading-hero-desktop);
      font-weight: 400;
      background: linear-gradient(135deg, #fff 0%, #e0f2fe 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      letter-spacing: -1px;
      line-height: 1.1;
      text-transform: uppercase;
    }
    
    .admin-hero-badge {
      display: inline-block;
      padding: 8px 18px;
      background: rgba(6,179,253,0.1);
      border: 1px solid rgba(6,179,253,0.3);
      border-radius: 12px;
      color: #38bdf8;
      font-size: var(--heading-badge);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      margin-top: 30px;
    }
    
    /* MAIN CONTAINER */
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px 60px;
    }
    
    /* Loading State */
    .admin-loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .admin-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .admin-hero {
        padding: 60px 20px 40px;
      }
      
      .admin-hero-title {
        font-size: var(--heading-hero-mobile);
      }
    }
  </style>
</head>
<body>
    <div class="auth-loading">
    <div class="auth-loading-spinner"></div>
  </div>
  
  <!-- Hero Section -->
  <div class="admin-hero">
    <div class="admin-hero-bg"></div>
    
    <div class="admin-hero-content">
      <h1 class="admin-hero-title">Admin Console</h1>
      <div class="admin-hero-badge">Practice Vault Management</div>
    </div>
  </div>
  
  <!-- Main Container -->
  <div class="admin-container">
    <div id="vault-admin-root"></div>
  </div>
  
  <!-- Admin Console Logic -->
  <script src="/config/course-data.js"></script>
  <script>
(function(){
var db;
var auth;
var rootEl;

// Load course configuration from shared file
// This ensures consistency across all pages
(function() {
  if (window.VAULT_COURSES) return; // Already loaded
  
  var script = document.createElement('script');
  script.src = 'course-data.js';
  script.async = false; // Synchronous to ensure it's loaded before console code runs
  document.head.appendChild(script);
})();

function pvGetFontBaseEl(){
  return (
    document.querySelector('.sqs-block-content') ||
    document.querySelector('.sqs-layout') ||
    document.getElementById('vault-admin-root') ||
    document.body
  );
}
function pvApplyFontFromBase(el){
  var baseEl = pvGetFontBaseEl();
  var cs = window.getComputedStyle(baseEl);
  if (cs.font && cs.font !== 'normal') el.style.font = cs.font;
  el.style.fontFamily = cs.fontFamily;
  el.style.fontSize = cs.fontSize;
  el.style.fontWeight = cs.fontWeight;
  el.style.lineHeight = cs.lineHeight;
  el.style.color = cs.color;
}

function escapeHtml(s){
  return String(s || '').replace(/[&<>"']/g, function (c) {
    return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c];
  });
}
function tsToMs(ts){
  if (!ts || !ts.toDate) return 0;
  try { return ts.toDate().getTime(); } catch (e) { return 0; }
}
function formatTs(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleString('en-AU', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Australia/Brisbane'
  });
}
function formatTsNoYear(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleString('en-AU', {
    day: 'numeric',
    month: 'short',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true,
    timeZone: 'Australia/Brisbane'
  });
}
function formatDateOnly(ts){
  if (!ts || !ts.toDate) return '-';
  return ts.toDate().toLocaleDateString('en-AU', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
    timeZone: 'Australia/Brisbane'
  });
}
function formatDuration(sec){
  sec = Number(sec || 0);
  if (sec <= 0) return '0 min';
  var mins = Math.round(sec / 60);
  if (mins < 60) return mins + ' min';
  var hours = Math.floor(mins / 60);
  var rem = mins % 60;
  return rem === 0 ? hours + ' hrs' : hours + ' hrs ' + rem + ' min';
}
function formatAvgTime(totalSeconds, loginCount){
  totalSeconds = Number(totalSeconds || 0);
  loginCount = Number(loginCount || 0);
  if (totalSeconds <= 0 || loginCount <= 0) return '0 min';
  return formatDuration(Math.round(totalSeconds / loginCount));
}
function statusDot(lastLoginTs, joinedAtTs){
  var ms = tsToMs(lastLoginTs);
  if (!ms) ms = tsToMs(joinedAtTs);
  if (!ms) return 'ðŸ”´';
  var days = (Date.now() - ms) / (1000 * 60 * 60 * 24);
  if (days < 14) return 'ðŸŸ¢';
  if (days < 30) return 'ðŸŸ¡';
  return 'ðŸ”´';
}
function formatRelativeTime(ts){
  if (!ts || !ts.toDate) return '';
  var ms = tsToMs(ts);
  if (!ms) return '';
  
  var now = Date.now();
  var diff = now - ms;
  var days = Math.floor(diff / (1000 * 60 * 60 * 24));
  var weeks = Math.floor(days / 7);
  var months = Math.floor(days / 30);
  var years = Math.floor(days / 365);
  
  if (days < 7) return '(' + days + ' day' + (days === 1 ? '' : 's') + ' ago)';
  if (weeks < 4) return '(' + weeks + ' week' + (weeks === 1 ? '' : 's') + ' ago)';
  if (months < 12) return '(' + months + ' month' + (months === 1 ? '' : 's') + ' ago)';
  
  var remainingMonths = months - (years * 12);
  if (remainingMonths === 0) return '(' + years + ' year' + (years === 1 ? '' : 's') + ' ago)';
  return '(' + years + ' year' + (years === 1 ? '' : 's') + ', ' + remainingMonths + ' month' + (remainingMonths === 1 ? '' : 's') + ' ago)';
}
function copyText(text){
  if (navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text);
  }
  return new Promise(function (resolve, reject) {
    try {
      var ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      var ok = document.execCommand('copy');
      document.body.removeChild(ta);
      ok ? resolve() : reject();
    } catch (e) { reject(e); }
  });
}
function showBody(){
  if (document.body) document.body.style.opacity = '1';
}

var INVITES_COL = 'invites';
var CREATE_ACCOUNT_URL_BASE = 'https://vault.davedrums.com.au/create-account?t=';

function randomToken(len){
  len = len || 16;
  try {
    var bytes = new Uint8Array(len);
    (window.crypto || window.msCrypto).getRandomValues(bytes);
    var out = '';
    for (var i = 0; i < bytes.length; i++) out += ('0' + bytes[i].toString(16)).slice(-2);
    return out;
  } catch (e) {
    return (Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2) + Date.now().toString(16)).slice(0, len * 2);
  }
}

function makeOverlay(){
  var overlay = document.createElement('div');
  overlay.setAttribute('role','dialog');
  overlay.setAttribute('aria-modal','true');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:18px;z-index:99999;font-family:Inter,sans-serif;';
  overlay.addEventListener('click', function(e){ if (e.target === overlay) overlay.remove(); });
  return overlay;
}

// NEW: Add User Modal with two-step process
function openAddUserModal(db){
  var overlay = makeOverlay();

  var box = document.createElement('div');
  box.style.cssText = 'width:100%;max-width:500px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);font-family:Inter,sans-serif;';

  var headerHtml = 
    '<div style="padding:24px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;">' +
      '<div>' +
        '<div style="font-size:20px;font-weight:600;color:#1a1a2e;">Add User</div>' +
        '<div style="font-size:14px;color:#999;margin-top:4px;">Create an invite link (7-day expiry)</div>' +
      '</div>' +
      '<button id="modal-close-btn" style="width:32px;height:32px;border:none;background:#f3f4f6;border-radius:8px;font-size:20px;cursor:pointer;color:#666;">&times;</button>' +
    '</div>';

  var step1Html = 
    '<div id="email-step" style="padding:24px;">' +
      '<div style="margin-bottom:20px;">' +
        '<label style="display:block;font-size:13px;font-weight:500;color:#444;margin-bottom:6px;">Email Address</label>' +
        '<input type="email" id="invite-email" placeholder="user@example.com" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;font-family:Inter,sans-serif;box-sizing:border-box;">' +
      '</div>' +
      '<div style="display:flex;gap:10px;">' +
        '<button id="invite-close" style="flex:1;padding:10px 16px;background:#f3f4f6;color:#444;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;">Close</button>' +
        '<button id="invite-create" style="flex:1;padding:10px 16px;background:#06b3fd;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;">Create Invite</button>' +
      '</div>' +
    '</div>';

  var step2Html = 
    '<div id="invite-link-step" style="padding:24px;display:none;">' +
      '<div style="background:#d1fae5;border:1px solid #10b981;border-radius:8px;padding:16px;margin-bottom:20px;text-align:center;">' +
        '<div style="font-size:24px;margin-bottom:8px;">âœ“</div>' +
        '<div style="font-size:15px;font-weight:600;color:#059669;font-family:Inter,sans-serif;">Invite Created Successfully</div>' +
      '</div>' +
      '<div style="margin-bottom:6px;">' +
        '<label style="display:block;font-size:13px;font-weight:500;color:#444;margin-bottom:6px;font-family:Inter,sans-serif;">Invite Link</label>' +
        '<textarea id="invite-url" readonly style="width:100%;min-height:80px;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;font-family:Courier New,monospace;background:#f8f9fa;color:#444;box-sizing:border-box;resize:none;"></textarea>' +
      '</div>' +
      '<div style="font-size:12px;color:#999;margin-bottom:16px;font-family:Inter,sans-serif;">Link expires in 7 days</div>' +
      '<button id="copy-invite" style="width:100%;padding:10px 16px;background:#06b3fd;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;margin-bottom:12px;">ðŸ“‹ Copy Link</button>' +
      '<button id="reset-modal" style="width:100%;padding:10px 16px;background:#f3f4f6;color:#444;border:1px solid #e5e7eb;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;">Close</button>' +
    '</div>';

  box.innerHTML = headerHtml + step1Html + step2Html;
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  function close(){ overlay.remove(); }
  
  box.querySelector('#modal-close-btn').addEventListener('click', close);
  box.querySelector('#invite-close').addEventListener('click', close);

  var emailInput = box.querySelector('#invite-email');
  var createBtn = box.querySelector('#invite-create');
  var step1 = box.querySelector('#email-step');
  var step2 = box.querySelector('#invite-link-step');
  var urlTextarea = box.querySelector('#invite-url');

  function resetModal(){
    step1.style.display = 'block';
    step2.style.display = 'none';
    emailInput.value = '';
  }

  box.querySelector('#reset-modal').addEventListener('click', close);

  createBtn.addEventListener('click', function(){
    var email = (emailInput.value || '').trim().toLowerCase();
    if (!email) {
      if (window.VaultErrors) window.VaultErrors.info('Please enter an email address');
      return;
    }

    createBtn.disabled = true;
    createBtn.textContent = 'Creating...';

    var token = randomToken(16);
    var expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
    
    db.collection(INVITES_COL).doc(token).set({
      email: email,
      used: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      expiresAt: firebase.firestore.Timestamp.fromDate(expires)
    }).then(function(){
      var link = CREATE_ACCOUNT_URL_BASE + token;
      
      step1.style.display = 'none';
      step2.style.display = 'block';
      urlTextarea.value = link;
      
      createBtn.disabled = false;
      createBtn.textContent = 'Create Invite';
    }).catch(function(err){
      createBtn.disabled = false;
      createBtn.textContent = 'Create Invite';
      if (window.VaultErrors) {
        window.VaultErrors.handle(err, 'Create Invite');
      } else {
        alert('Failed to create invite');
      }
    });
  });

  box.querySelector('#copy-invite').addEventListener('click', function(){
    copyText(urlTextarea.value).then(function(){
      if (window.VaultErrors) {
        window.VaultErrors.success('Invite link copied!');
      }
    }).catch(function(){
      if (window.VaultErrors) {
        window.VaultErrors.info('Failed to copy link');
      }
    });
  });
}

// NEW: Invites Modal with revoke for all invites
function openInvitesModal(db){
  var overlay = makeOverlay();

  var box = document.createElement('div');
  box.style.cssText = 'width:100%;max-width:900px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-height:85vh;display:flex;flex-direction:column;font-family:Inter,sans-serif;';

  box.innerHTML =
    '<div style="padding:24px;border-bottom:1px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;">' +
      '<div>' +
        '<div style="font-size:20px;font-weight:600;color:#1a1a2e;font-family:Inter,sans-serif;">Invitation Links</div>' +
        '<div style="font-size:14px;color:#999;margin-top:4px;font-family:Inter,sans-serif;">Manage user invitations</div>' +
      '</div>' +
      '<button id="invites-close" style="width:32px;height:32px;border:none;background:#f3f4f6;border-radius:8px;font-size:20px;cursor:pointer;color:#666;">&times;</button>' +
    '</div>' +
    '<div id="invites-list-container" style="flex:1;overflow-y:auto;padding:20px;"></div>';

  overlay.appendChild(box);
  document.body.appendChild(overlay);

  function close(){ overlay.remove(); }
  box.querySelector('#invites-close').addEventListener('click', close);

  var listContainer = box.querySelector('#invites-list-container');
  listContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">Loading...</div>';

  db.collection(INVITES_COL).orderBy('createdAt', 'desc').limit(100).get()
    .then(function(snap){
      if (snap.empty) {
        listContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">No invites yet.</div>';
        return;
      }

      var tableHtml = 
        '<div style="background:#f8f9fa;border:1px solid #e9ecef;border-radius:10px;overflow:hidden;">' +
          '<div style="display:grid;grid-template-columns:2fr 1fr 1.5fr 1.5fr 1fr;gap:12px;padding:14px 16px;background:#e9ecef;font-size:12px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px;font-family:Inter,sans-serif;">' +
            '<div>Email</div>' +
            '<div>Status</div>' +
            '<div>Created</div>' +
            '<div>Expires</div>' +
            '<div>Action</div>' +
          '</div>';

      snap.forEach(function(doc){
        var d = doc.data();
        var email = d.email || '-';
        var used = d.used === true;
        var createdAt = d.createdAt ? formatDateOnly(d.createdAt) : '-';
        var expiresAt = d.expiresAt ? formatDateOnly(d.expiresAt) : '-';
        
        var now = Date.now();
        var expiryMs = tsToMs(d.expiresAt);
        var isExpired = expiryMs > 0 && now > expiryMs;

        var status, statusBg, statusColor;
        if (used) {
          status = 'Used';
          statusBg = '#e0f2fe';
          statusColor = '#0284c7';
        } else if (isExpired) {
          status = 'Expired';
          statusBg = '#fee2e2';
          statusColor = '#dc2626';
        } else {
          status = 'Active';
          statusBg = '#d1fae5';
          statusColor = '#059669';
        }

        var opacity = (used || isExpired) ? '0.6' : '1';

        tableHtml += 
          '<div style="display:grid;grid-template-columns:2fr 1fr 1.5fr 1.5fr 1fr;gap:12px;padding:14px 16px;border-bottom:1px solid #e9ecef;background:white;align-items:center;font-family:Inter,sans-serif;opacity:' + opacity + ';">' +
            '<div style="font-size:14px;color:#1a1a2e;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">' + escapeHtml(email) + '</div>' +
            '<div>' +
              '<span style="display:inline-block;padding:4px 10px;background:' + statusBg + ';color:' + statusColor + ';border-radius:12px;font-size:12px;font-weight:600;">' + status + '</span>' +
            '</div>' +
            '<div style="font-size:13px;color:#666;">' + createdAt + '</div>' +
            '<div style="font-size:13px;color:#666;">' + expiresAt + '</div>' +
            '<div>' +
              (used ? '<span style="font-size:12px;color:#999;font-style:italic;">â€”</span>' : 
                '<button class="revoke-invite-btn" data-invite-id="' + doc.id + '" style="padding:6px 12px;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;">Revoke</button>') +
            '</div>' +
          '</div>';
      });

      tableHtml += '</div>';
      listContainer.innerHTML = tableHtml;

      listContainer.querySelectorAll('.revoke-invite-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          var inviteId = btn.getAttribute('data-invite-id');
          if (confirm('Revoke this invitation? The link will no longer work.')) {
            db.collection(INVITES_COL).doc(inviteId).delete()
              .then(function(){
                if (window.VaultErrors) {
                  window.VaultErrors.success('Invitation revoked');
                }
                overlay.remove();
                openInvitesModal(db);
              })
              .catch(function(e){
                if (window.VaultErrors) {
                  window.VaultErrors.handle(e, 'Revoke Invite');
                } else {
                  alert('Failed to revoke invite');
                }
              });
          }
        });
      });
    })
    .catch(function(e){
      listContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#dc2626;">Error loading invites</div>';
      if (window.VaultErrors) {
        window.VaultErrors.handle(e, 'Load Invites');
      }
    });
}

var ONLINE_WINDOW_MS = 3 * 60 * 1000;

document.addEventListener('DOMContentLoaded', function(){
  if (typeof firebase === 'undefined' || !firebase.auth || !firebase.firestore) return;

  auth = firebase.auth();
  db = firebase.firestore();
  rootEl = document.getElementById('vault-admin-root');
  if (!rootEl) return;

  function pvIsAdmin(user){
    if (!user || !user.uid) return Promise.resolve(false);
    return db.collection('admins').doc(user.uid).get()
      .then(function(doc){ return doc.exists; })
      .catch(function(){ return false; });
  }

  // NEW: Inline accordion editing - no separate profile modal
  function saveUserChanges(uid, accordionEl){
    var firstName = accordionEl.querySelector('.edit-firstname').value.trim();
    var lastName = accordionEl.querySelector('.edit-lastname').value.trim();
    var displayName = accordionEl.querySelector('.edit-displayname').value.trim();
    var ageConfirmed = accordionEl.querySelector('.edit-age-confirmed').checked;
    var selfProgress = accordionEl.querySelector('.edit-self-progress').checked;

    var updates = {
      firstName: firstName,
      lastName: lastName,
      displayName: displayName,
      ageConfirmed: ageConfirmed,
      selfProgress: selfProgress
    };

    db.collection('users').doc(uid).set(updates, { merge: true })
      .then(function(){
        if (window.VaultErrors) {
          window.VaultErrors.success('Changes saved');
        }
        loadOnce();
      })
      .catch(function(e){
        if (window.VaultErrors) {
          window.VaultErrors.handle(e, 'Save Changes');
        } else {
          alert('Save failed');
        }
      });
  }

  function openProgressModal(db, uid, displayName){
    var overlay = makeOverlay();

    var box = document.createElement('div');
    box.style.cssText = 'width:100%;max-width:600px;background:#fff;border-radius:12px;' +
      'box-shadow:0 10px 40px rgba(0,0,0,.25);padding:22px;max-height:90vh;overflow-y:auto;font-family:Inter,sans-serif;';

    var header = document.createElement('h4');
    header.textContent = 'Progress: ' + displayName;
    header.style.cssText = 'margin:0 0 16px 0;color:#111;font-size:16px;font-weight:300;font-family:Oswald,sans-serif;';
    box.appendChild(header);

    var selfProgressContainer = document.createElement('div');
    selfProgressContainer.style.cssText = 'margin-bottom:20px;padding:12px;background:#f9f9f9;border-radius:8px;';
    
    var selfProgressLabel = document.createElement('label');
    selfProgressLabel.style.cssText = 'display:flex;align-items:center;gap:10px;cursor:pointer;';
    
    var selfProgressCheckbox = document.createElement('input');
    selfProgressCheckbox.type = 'checkbox';
    selfProgressCheckbox.id = 'admin-self-progress';
    selfProgressCheckbox.style.cssText = 'width:18px;height:18px;cursor:pointer;';
    
    var selfProgressText = document.createElement('span');
    selfProgressText.textContent = 'Allow self-progress (user can mark lessons complete)';
    selfProgressText.style.cssText = 'font-size:14px;color:#333;font-family:Inter,sans-serif;';
    
    selfProgressLabel.appendChild(selfProgressCheckbox);
    selfProgressLabel.appendChild(selfProgressText);
    selfProgressContainer.appendChild(selfProgressLabel);
    box.appendChild(selfProgressContainer);

    db.collection('users').doc(uid).get().then(function(userSnap){
      if (userSnap.exists) {
        selfProgressCheckbox.checked = userSnap.data().selfProgress === true;
      }
    });

    selfProgressCheckbox.addEventListener('change', function(){
      db.collection('users').doc(uid).set({
        selfProgress: selfProgressCheckbox.checked
      }, { merge: true })
      .then(function(){
        if(window.VaultToast) window.VaultToast.success('Self-progress ' + (selfProgressCheckbox.checked ? 'enabled' : 'disabled'));
      })
      .catch(function(e){
        console.error('Failed to update selfProgress:', e);
        if(window.VaultToast) window.VaultToast.error('Failed to update');
      });
    });

    var courseLabel = document.createElement('label');
    courseLabel.textContent = 'Select Course:';
    courseLabel.style.cssText = 'display:block;margin:0 0 8px 0;font-weight:600;color:#111;font-family:Inter,sans-serif;';
    box.appendChild(courseLabel);

    var courseSelect = document.createElement('select');
    courseSelect.style.cssText = 'width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;margin-bottom:16px;font-family:Inter,sans-serif;';

    if (typeof window.VAULT_COURSES !== 'undefined' && window.VAULT_COURSES.length) {
      window.VAULT_COURSES.forEach(function(c){
        var opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        courseSelect.appendChild(opt);
      });
    } else {
      var opt = document.createElement('option');
      opt.textContent = 'No courses available';
      opt.disabled = true;
      courseSelect.appendChild(opt);
    }

    box.appendChild(courseSelect);

    var container = document.createElement('div');
    container.style.cssText = 'margin-top:12px;';
    box.appendChild(container);

    function loadCourseProgress(courseId){
      container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;font-family:Inter,sans-serif;">Loading...</div>';

      var course = null;
      if (window.VAULT_COURSES) {
        for (var i = 0; i < window.VAULT_COURSES.length; i++) {
          if (window.VAULT_COURSES[i].id === courseId) {
            course = window.VAULT_COURSES[i];
            break;
          }
        }
      }

      if (!course || !course.lessons || !course.lessons.length) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;font-family:Inter,sans-serif;">No lessons found for this course.</div>';
        return;
      }

      db.collection('users').doc(uid).collection('progress').doc(courseId).get()
        .then(function(doc){
          var data = doc.exists ? (doc.data() || {}) : {};
          var completed = data.completed || {};

          var list = document.createElement('div');
          list.style.cssText = 'display:flex;flex-direction:column;gap:8px;';

          course.lessons.forEach(function(lessonId){
            var isCompleted = completed[lessonId] === true;

            var item = document.createElement('label');
            item.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px;background:#f9f9f9;border:1px solid #e0e0e0;border-radius:6px;cursor:pointer;';

            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = isCompleted;
            checkbox.style.cssText = 'width:18px;height:18px;cursor:pointer;';

            checkbox.addEventListener('change', function(){
              var newState = checkbox.checked;
              checkbox.disabled = true;
              toggleAdminCompletion(db, uid, courseId, lessonId, newState, checkbox);
            });

            var label = document.createElement('span');
            label.textContent = 'Lesson ' + lessonId;
            label.style.cssText = 'font-size:14px;color:#333;font-family:Inter,sans-serif;';

            item.appendChild(checkbox);
            item.appendChild(label);
            list.appendChild(item);
          });

          container.appendChild(list);
        })
        .catch(function(e){
          console.error('Failed to load progress:', e);
          container.innerHTML = '<div style="text-align:center;padding:20px;color:#c00;font-family:Inter,sans-serif;">Error loading progress</div>';
        });
    }

    function toggleAdminCompletion(db, uid, courseId, lessonId, newState, checkbox){
      db.collection('users').doc(uid).collection('progress').doc(courseId)
        .set({
          completed: {
            [lessonId]: newState
          },
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true })
        .then(function(){
          checkbox.disabled = false;
          if(window.VaultToast) window.VaultToast.success('Updated: Lesson ' + lessonId);
        })
        .catch(function(e){
          checkbox.checked = !newState;
          checkbox.disabled = false;
          console.error('Failed to update:', e);
          
          if(window.VaultToast) {
            window.VaultToast.error('Update failed: ' + e.message);
          } else {
            alert('Update failed: ' + e.message);
          }
        });
    }

    courseSelect.addEventListener('change', function(){
      loadCourseProgress(courseSelect.value);
    });

    if (courseSelect.options.length > 0 && courseSelect.value) {
      loadCourseProgress(courseSelect.value);
    }

    var closeBtn = document.createElement('button');
    closeBtn.textContent = 'Close';
    closeBtn.style.cssText = 'margin-top:20px;width:100%;padding:10px;border:1px solid #ccc;background:#f3f3f3;border-radius:8px;cursor:pointer;font-family:Inter,sans-serif;font-size:14px;';
    closeBtn.addEventListener('click', function(){ overlay.remove(); });
    box.appendChild(closeBtn);

    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }

  function bindHandlers(){
    // Toggle accordion
    rootEl.querySelectorAll('.accordion-header').forEach(function(header){
      header.addEventListener('click', function(){
        var item = header.closest('.accordion-item');
        var wasOpen = item.classList.contains('open');

        // Close all
        rootEl.querySelectorAll('.accordion-item').forEach(function(i){
          i.classList.remove('open');
        });

        // Open clicked if wasn't open
        if (!wasOpen) {
          item.classList.add('open');
        }
      });
    });

    // Save Changes buttons
    rootEl.querySelectorAll('.save-changes-btn').forEach(function(btn){
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        var uid = btn.getAttribute('data-uid');
        var accordionEl = btn.closest('.accordion-item');
        saveUserChanges(uid, accordionEl);
      });
    });

    // View Progress buttons
    rootEl.querySelectorAll('.view-progress-btn').forEach(function(btn){
      btn.addEventListener('click', function(e){
        e.stopPropagation();
        var uid = btn.getAttribute('data-uid');
        var displayName = btn.getAttribute('data-name');
        openProgressModal(db, uid, displayName);
      });
    });

    var addBtn = rootEl.querySelector('#pv-add-user-btn');
    if (addBtn) addBtn.addEventListener('click', function(){ openAddUserModal(db); });

    var invitesBtn = rootEl.querySelector('#pv-invites-btn');
    if (invitesBtn) invitesBtn.addEventListener('click', function(){ openInvitesModal(db); });
  }

  // NEW: Render accordion layout
  function render(users){
    var nowMs = Date.now();

    var online = users.filter(function(u){
      return (nowMs - tsToMs(u.lastActive)) <= ONLINE_WINDOW_MS;
    }).sort(function(a,b){ return tsToMs(b.lastActive) - tsToMs(a.lastActive); });

    users.sort(function(a,b){
      var aT = tsToMs(a.lastLogin) || tsToMs(a.joinedAt) || tsToMs(a.lastActive);
      var bT = tsToMs(b.lastLogin) || tsToMs(b.joinedAt) || tsToMs(b.lastActive);
      return bT - aT;
    });

    var onlineText = online.length
      ? ('ðŸ¥ ' + online.map(function(u){ return escapeHtml(u.email); }).join(', '))
      : 'No one online right now.';

    var html = '';
    
    // Currently Online section
    html += '<div style="margin:0 0 18px 0;padding:18px 20px;border-radius:12px;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,0.08);">';
    html += '<h4 style="margin:0 0 10px 0;font-family:Oswald,sans-serif;font-size:16px;font-weight:400;text-transform:uppercase;letter-spacing:0.5px;">CURRENTLY ONLINE</h4>';
    html += '<div style="font-size:14px;line-height:1.5;word-break:break-word;font-family:Inter,sans-serif;">' + onlineText + '</div>';
    html += '</div>';

    // Student List section with accordion
    html += '<div style="background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);">';
    html += '<div style="padding:20px;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;">' +
              '<div style="font-family:Oswald,sans-serif;font-size:18px;font-weight:600;color:#1a1a2e;">Student List (' + users.length + ')</div>' +
              '<div style="display:flex;gap:10px;">' +
                '<button id="pv-invites-btn" style="padding:10px 18px;background:#6b7280;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;">Invites</button>' +
                '<button id="pv-add-user-btn" style="padding:10px 18px;background:#06b3fd;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;">+ Add User</button>' +
              '</div>' +
            '</div>';

    html += '<div style="padding:12px;">';

    if (!users.length) {
      html += '<div style="padding:40px 20px;text-align:center;color:#999;font-family:Inter,sans-serif;">No students yet.</div>';
    } else {
      users.forEach(function(u){
        var isOnline = (nowMs - tsToMs(u.lastActive)) <= ONLINE_WINDOW_MS;
        var activityDot = statusDot(u.lastLogin, u.joinedAt);
        
        var statusBadgeClass = isOnline ? '' : ' offline';
        var statusText = isOnline ? 'Online' : 'Offline';

        html += '<div class="accordion-item" style="background:#fafafa;border:1px solid #e0e0e0;margin-bottom:10px;border-radius:10px;overflow:hidden;transition:all 0.2s;">';
        
        // Accordion Header (collapsed view)
        html += '<div class="accordion-header" style="display:flex;justify-content:space-between;align-items:center;padding:16px;cursor:pointer;transition:background 0.2s;">';
        html += '<div style="flex:1;min-width:0;">';
        html += '<div style="font-weight:600;font-size:15px;color:#1a1a2e;margin-bottom:4px;font-family:Inter,sans-serif;">' + escapeHtml(u.fullName || u.displayName || 'No name') + '</div>';
        html += '<div style="font-size:13px;color:#999;display:flex;align-items:center;gap:8px;flex-wrap:wrap;font-family:Inter,sans-serif;">';
        html += '<span>' + escapeHtml(u.email) + '</span>';
        html += '<span>â€¢</span>';
        html += '<span>Last: ' + formatTsNoYear(u.lastLogin) + '</span>';
        html += '<span style="font-size:16px;">' + activityDot + '</span>';
        html += '</div>';
        html += '</div>';
        html += '<div style="display:flex;align-items:center;gap:12px;">';
        html += '<div class="status-badge' + statusBadgeClass + '" style="display:inline-flex;align-items:center;gap:8px;padding:6px 14px;background:' + (isOnline ? '#e8f9f3' : '#f3f4f6') + ';color:' + (isOnline ? '#059669' : '#999') + ';border-radius:14px;font-size:15px;font-weight:600;white-space:nowrap;font-family:Inter,sans-serif;">';
        html += '<span style="width:8px;height:8px;border-radius:50%;background:' + (isOnline ? '#059669' : '#999') + ';"></span>';
        html += statusText;
        html += '</div>';
        html += '<div class="chevron" style="color:#999;font-size:20px;transition:transform 0.2s;">â€º</div>';
        html += '</div>';
        html += '</div>';

        // Accordion Body (expanded view) - inline editing
        html += '<div class="accordion-body" style="max-height:0;overflow:hidden;transition:max-height 0.3s ease;">';
        html += '<div class="accordion-content" style="padding:20px;border-top:1px solid #f0f0f0;background:white;">';
        
        // Practice Statistics
        html += '<span style="display:block;font-size:12px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;font-family:Inter,sans-serif;">Practice Statistics</span>';
        html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px;">';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:11px;color:#999;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;font-family:Inter,sans-serif;">Last Login</div>';
        html += '<div style="font-size:16px;font-weight:600;color:#1a1a2e;font-family:Inter,sans-serif;">' + formatTs(u.lastLogin) + '</div>';
        html += '</div>';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:11px;color:#999;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;font-family:Inter,sans-serif;">Avg Session</div>';
        html += '<div style="font-size:16px;font-weight:600;color:#1a1a2e;font-family:Inter,sans-serif;">' + formatAvgTime(u.totalSeconds, u.loginCount) + '</div>';
        html += '</div>';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:11px;color:#999;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;font-family:Inter,sans-serif;">Total Practice</div>';
        html += '<div style="font-size:16px;font-weight:600;color:#1a1a2e;font-family:Inter,sans-serif;">' + formatDuration(u.totalSeconds) + '</div>';
        html += '</div>';
        html += '<div style="background:#f8f9fa;padding:12px;border-radius:8px;border:1px solid #e9ecef;">';
        html += '<div style="font-size:11px;color:#999;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;font-family:Inter,sans-serif;">Login Count</div>';
        html += '<div style="font-size:16px;font-weight:600;color:#1a1a2e;font-family:Inter,sans-serif;">' + (u.loginCount || 0) + ' times</div>';
        html += '</div>';
        html += '</div>';

        // Profile Information (3 columns)
        html += '<div style="margin-bottom:24px;">';
        html += '<span style="display:block;font-size:12px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;font-family:Inter,sans-serif;">Profile Information</span>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">';
        html += '<div>';
        html += '<label style="display:block;font-size:13px;font-weight:500;color:#444;margin-bottom:6px;font-family:Inter,sans-serif;">First Name</label>';
        html += '<input type="text" class="edit-firstname" value="' + escapeHtml(u.firstName) + '" placeholder="First name" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;font-family:Inter,sans-serif;box-sizing:border-box;">';
        html += '</div>';
        html += '<div>';
        html += '<label style="display:block;font-size:13px;font-weight:500;color:#444;margin-bottom:6px;font-family:Inter,sans-serif;">Last Name</label>';
        html += '<input type="text" class="edit-lastname" value="' + escapeHtml(u.lastName) + '" placeholder="Last name" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;font-family:Inter,sans-serif;box-sizing:border-box;">';
        html += '</div>';
        html += '<div>';
        html += '<label style="display:block;font-size:13px;font-weight:500;color:#444;margin-bottom:6px;font-family:Inter,sans-serif;">Display Name</label>';
        html += '<input type="text" class="edit-displayname" value="' + escapeHtml(u.displayName) + '" placeholder="Display name" style="width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;font-family:Inter,sans-serif;box-sizing:border-box;">';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        // Account Permissions (2 columns)
        html += '<div style="margin-bottom:24px;">';
        html += '<span style="display:block;font-size:12px;font-weight:600;color:#666;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;font-family:Inter,sans-serif;">Account Permissions</span>';
        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">';
        html += '<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;cursor:pointer;transition:all 0.2s;margin-bottom:0;">';
        html += '<input type="checkbox" class="edit-age-confirmed" ' + (u.ageConfirmed ? 'checked' : '') + ' style="width:18px;height:18px;cursor:pointer;accent-color:#06b3fd;">';
        html += '<span style="flex:1;font-size:14px;color:#1a1a2e;cursor:pointer;font-family:Inter,sans-serif;">16+ years old (can access comments)</span>';
        html += '</label>';
        html += '<label style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;cursor:pointer;transition:all 0.2s;margin-bottom:0;">';
        html += '<input type="checkbox" class="edit-self-progress" ' + (u.selfProgress ? 'checked' : '') + ' style="width:18px;height:18px;cursor:pointer;accent-color:#06b3fd;">';
        html += '<span style="flex:1;font-size:14px;color:#1a1a2e;cursor:pointer;font-family:Inter,sans-serif;">Allow self-progress (can complete lessons)</span>';
        html += '</label>';
        html += '</div>';
        html += '</div>';

        // Action Buttons
        html += '<div style="display:flex;gap:10px;padding-top:16px;border-top:1px solid #f0f0f0;">';
        html += '<button class="save-changes-btn" data-uid="' + escapeHtml(u.uid) + '" style="flex:1;padding:10px 16px;background:#06b3fd;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;transition:all 0.2s;">Save Changes</button>';
        html += '<button class="view-progress-btn" data-uid="' + escapeHtml(u.uid) + '" data-name="' + escapeHtml(u.fullName || u.displayName || u.email) + '" style="flex:1;padding:10px 16px;background:#10b981;color:white;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:Inter,sans-serif;transition:all 0.2s;">View Progress</button>';
        html += '</div>';

        html += '</div>';
        html += '</div>';

        html += '</div>';
      });
    }

    html += '</div>';
    html += '</div>';

    rootEl.innerHTML = html;
    
    // Add CSS for accordion animations
    if (!document.getElementById('admin-accordion-css')) {
      var style = document.createElement('style');
      style.id = 'admin-accordion-css';
      style.textContent = 
        '.accordion-item.open { background: white !important; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }' +
        '.accordion-item.open .accordion-body { max-height: 2000px !important; }' +
        '.accordion-item.open .chevron { transform: rotate(90deg); }' +
        '.accordion-header:hover { background: rgba(6,179,253,0.05); }' +
        '.save-changes-btn:hover { background: #0590d4; transform: translateY(-1px); }' +
        '.view-progress-btn:hover { background: #059669; transform: translateY(-1px); }' +
        '@media (max-width: 768px) {' +
          '.accordion-item .accordion-content > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }' +
        '}';
      document.head.appendChild(style);
    }

    bindHandlers();
  }

  function loadOnce(){
    return Promise.all([
      db.collection('users').get(),
      db.collection('admins').get()
    ]).then(function(results){
      var usersSnap = results[0];
      var adminSnap = results[1];
      
      var adminUids = {};
      adminSnap.forEach(function(doc){ adminUids[doc.id] = true; });
      
      var users = [];
      usersSnap.forEach(function(d){
        var data = d.data() || {};
        
        if (adminUids[d.id]) return;
        
        users.push({
          uid: d.id,
          email: data.email || '',
          firstName: data.firstName || '',
          lastName: data.lastName || '',
          displayName: data.displayName || '',
          ageConfirmed: data.ageConfirmed === true,
          selfProgress: data.selfProgress === true,
          joinedAt: data.createdAt || null,
          fullName: (data.firstName && data.lastName) ? (data.firstName + ' ' + data.lastName).trim() : (data.displayName || '-')
        });
      });

      var statGets = users.map(function(u){
        return db.collection('users').doc(u.uid).collection('metrics').doc('stats').get()
          .then(function(s){ return { uid: u.uid, data: (s.exists ? (s.data() || {}) : {}) }; });
      });

      var progGets = users.map(function(u){
        return db.collection('users').doc(u.uid).collection('metrics').doc('progress').get()
          .then(function(s){ return { uid: u.uid, data: (s.exists ? (s.data() || {}) : {}) }; });
      });

      return Promise.all([Promise.all(statGets), Promise.all(progGets)]).then(function(res){
        var statsArr = res[0];
        var progArr = res[1];

        var statsByUid = {};
        statsArr.forEach(function(x){ statsByUid[x.uid] = x.data || {}; });

        var progByUid = {};
        progArr.forEach(function(x){ progByUid[x.uid] = x.data || {}; });

        users.forEach(function(u){
          var st = statsByUid[u.uid] || {};
          var pr = progByUid[u.uid] || {};

          u.lastLogin = st.lastLoginAt || null;
          u.lastActive = st.lastSeenAt || st.lastLoginAt || null;
          u.lastDeviceType = st.lastDeviceType || '';
          u.lastDeviceEmoji = st.lastDeviceEmoji || '';
          u.loginCount = (typeof st.loginCount === 'number') ? st.loginCount : 0;
          u.totalSeconds = (typeof st.totalSeconds === 'number') ? st.totalSeconds : 0;
          u.progress = pr || {};
        });

        render(users);
      });
    }).catch(function(e){
      console.error(e);
      if (window.VaultErrors) {
        window.VaultErrors.handle(e, 'Load Admin Data');
      } else {
        alert('Load error: ' + (e && e.message || e));
      }
    });
  }

  auth.onAuthStateChanged(function(user){
    showBody();

    if (!user) {
      // Not logged in - redirect to login
      window.location.href = '/members';
      return;
    }

    pvIsAdmin(user).then(function(ok){
      if (!ok) {
        // Logged in but not admin - redirect to home
        window.location.href = '/';
        return;
      }

      loadOnce().catch(function(e){
        rootEl.textContent = (e && e.message) ? e.message : 'Error loading admin data.';
      });

      setInterval(function(){ loadOnce().catch(function(){}); }, 15000);
    });
  });
});
})();
  </script>

</body>
</html>
