<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Practice Stats | Practice Vault</title>
  <link rel="icon" href="/assets/favicon.ico">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/core.css">
  <link rel="stylesheet" href="/css/account.css">
  
  <!-- Firebase -->
  <script src="/firebase/firebase-app-compat.js"></script>
  <script src="/firebase/firebase-auth-compat.js"></script>
  <script src="/firebase/firebase-firestore-compat.js"></script>
  <script src="/firebase/firebase-init.js"></script>
  
  <!-- Chart.js for practice stats -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Components -->
  <script src="/config/components.js"></script>
  <script src="/config/navigation.js"></script>
  <script src="/config/error-handler.js"></script>
  <script src="/config/cues.js"></script>
  <script src="/config/course-data.js"></script>
</head>
<body>

  <!-- Loading spinner -->
  <div id="page-loader" class="page-loader">
    <div class="loading-spinner"></div>
  </div>
  
  <!-- HERO HEADER -->
<div class="hero">
  <div class="hero-banner" data-bg="members"></div>
  <div class="hero-content">
    <h1 class="hero-title">My Stats</h1>
  </div>
</div>
  
  <!-- STATS CONTENT -->
  <div class="members-container">
    <div id="stats-content"></div>
  </div>

  <script>
  (function(){
    'use strict';
    
    var db;
    var currentUser;
    
    // Wait for Firebase
    var tries = 0;
    function waitForFirebase(){
      tries++;
      if (typeof firebase === 'undefined' || !firebase.auth || !firebase.firestore) {
        if (tries < 80) return setTimeout(waitForFirebase, 50);
        console.error('Firebase not loaded');
        return;
      }
      init();
    }
    
    function init(){
      var auth = firebase.auth();
      db = firebase.firestore();
      
      var loadingEl = document.querySelector('.auth-loading');
      var contentEl = document.getElementById('stats-content');
      
      // Auth guard - redirect if not logged in
      auth.onAuthStateChanged(function(user){
        // Hide loading spinner
        if (loadingEl) loadingEl.style.display = 'none';
        
        if (!user) {
          // Not logged in - redirect to login
          window.location.href = '/login';
          return;
        }
        
        currentUser = user;
        
        // Build stats UI
        buildStats(user);
      });
    }
    
    function buildStats(user){
      var contentEl = document.getElementById('stats-content');
      if (!contentEl) return;
      
      // My Progress section
      var progressSection = createOpenSection('My Progress', function(){
        return createPracticeContent(user);
      });
      contentEl.appendChild(progressSection);
      
      // My Stats section
      var statsSection = createOpenSection('My Stats', function(){
        return createStatsContent(user);
      });
      contentEl.appendChild(statsSection);
      
      // My Goals section
      var goalsSection = createOpenSection('My Goals', function(){
        return createGoalsContent(user);
      });
      contentEl.appendChild(goalsSection);
    }
    
    // Helper: Create section with title and content
    function createOpenSection(title, contentBuilder){
      var section = document.createElement('div');
      section.className = 'section';
      
      var header = document.createElement('div');
      header.className = 'section-header';
      
      var titleEl = document.createElement('h2');
      titleEl.className = 'section-title';
      titleEl.textContent = title;
      
      header.appendChild(titleEl);
      section.appendChild(header);
      
      var content = contentBuilder();
      section.appendChild(content);
      
      return section;
    }
    
    
    // Create Practice Content (pathway progress cards)
function createPracticeContent(user){
  var content = document.createElement('div');
  
  // Load progress to find active courses and last lesson
  db.collection('users').doc(user.uid).collection('progress').get()
    .then(function(progressSnap){
      var activeCourses = {};
      var lastActivePathway = null;
      var lastActiveCourseId = null;
      var mostRecentTime = 0;
      
      // Process all progress docs
      progressSnap.forEach(function(doc) {
        var courseId = doc.id;
        var data = doc.data();
        var time = data.lastUpdated ? data.lastUpdated.toMillis() : 0;
        
        // Track active courses by pathway
        if (window.VAULT_COURSES && window.VAULT_COURSES[courseId]) {
          var pathway = window.VAULT_COURSES[courseId].pathway;
          activeCourses[pathway] = courseId;
        }
        
        // Find most recent for continue button
        if (time > mostRecentTime && data.lastLesson) {
          mostRecentTime = time;
          lastActiveCourseId = courseId;
          
          if (window.VAULT_COURSES && window.VAULT_COURSES[courseId]) {
            lastActivePathway = window.VAULT_COURSES[courseId].pathway;
          }
        }
      });
      
      // Render pathway cards
      renderPathwayCards(content, user.uid, activeCourses, lastActivePathway, lastActiveCourseId);
    })
    .catch(function(e){
      console.error('Failed to load progress:', e);
      content.textContent = 'Error loading progress.';
    });
  
  return content;
}
    
    function renderPathwayCards(container, uid, activeCourses, lastActivePathway, lastActiveCourseId){
      var grid = document.createElement('div');
      grid.className = 'stats-grid';
      
      var pathways = ['gs', 'fs', 'ss', 'ks', 'rs'];
      var pathwayConfig = {
        gs: { label: 'Groove Studies', key: 'gs' },
        fs: { label: 'Fill Studies', key: 'fs' },
        ss: { label: 'Stick Studies', key: 'ss' },
        ks: { label: 'Kick Studies', key: 'ks' },
        rs: { label: 'Rhythm Studies', key: 'rs' }
      };
      
      pathways.forEach(function(pathway){
        var config = pathwayConfig[pathway];
        var courseId = activeCourses[pathway] || null;
        
        var box = document.createElement('div');
        box.className = 'stat-card';
        
        var headerEl = document.createElement('div');
        headerEl.className = 'stat-header';
        
        var labelEl = document.createElement('div');
        labelEl.className = 'stat-label';
        labelEl.textContent = config.label;
        
        var statusEl = document.createElement('div');
        statusEl.className = 'stat-subtitle';
        
        var progressEl = document.createElement('div');
        progressEl.className = 'stat-value';
        
        var progressContainer = document.createElement('div');
        progressContainer.className = 'stat-progress';
        
        var barContainer = document.createElement('div');
        barContainer.className = 'stat-bar-bg';
        
        var barFill = document.createElement('div');
        barFill.className = 'stat-bar-fill';
        
        barContainer.appendChild(barFill);
        progressContainer.appendChild(barContainer);
        
        headerEl.appendChild(labelEl);
        headerEl.appendChild(statusEl);
        
        box.appendChild(headerEl);
        box.appendChild(progressEl);
        box.appendChild(progressContainer);
        
        grid.appendChild(box);
        
        // Load progress if course is active
        if (courseId) {
          statusEl.textContent = 'Last active: ' + courseId.toUpperCase();
          
          var courseConfig = window.VAULT_COURSES && window.VAULT_COURSES[courseId];
          if (courseConfig) {
            loadCourseProgress(uid, courseId, courseConfig, progressEl, barFill);
          } else {
            progressEl.textContent = '‚Äî';
            statusEl.textContent = 'Course not configured';
            barFill.style.width = '0%';
          }
        } else {
          statusEl.textContent = 'No active course';
          barFill.style.width = '0%';
          progressEl.textContent = '‚Äî';
        }
        
        // Highlight last active pathway
        if (pathway === lastActivePathway) {
          box.style.borderColor = '#06b3fd';
          box.style.borderWidth = '2px';
        }
      });
      
      container.appendChild(grid);
    }
    
    function loadCourseProgress(uid, courseId, courseConfig, progressEl, barFill){
      db.collection('users').doc(uid).collection('progress').doc(courseId).get()
        .then(function(snap){
          var completedCount = 0;
          if (snap.exists) {
            var data = snap.data();
            var completed = data.completed || [];
            
            // Use shared normalization function
            var completedArray = window.normalizeCompleted ? window.normalizeCompleted(completed) : (Array.isArray(completed) ? completed : []);
            
            // Count completed lessons
            courseConfig.lessons.forEach(function(lessonId){
              if (completedArray.indexOf(lessonId) !== -1) {
                completedCount++;
              }
            });
          }
          
          var totalLessons = courseConfig.lessons.length;
          var percent = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
          
          progressEl.textContent = completedCount + '/' + totalLessons;
          barFill.style.width = percent + '%';
        })
        .catch(function(e){
          console.error('Failed to load course progress:', e);
          progressEl.textContent = '‚Äî';
        });
    }
    
    // Create Stats Content (chart + stats cards + timeline)
    function createStatsContent(user){
      var content = document.createElement('div');
      
      // 30-day practice graph
      var graphContainer = document.createElement('div');
      graphContainer.className = 'stats-chart-container';
      
      var graphTitle = document.createElement('div');
      graphTitle.className = 'chart-title';
      graphTitle.textContent = 'Last 30 Days';
      
      var canvasContainer = document.createElement('div');
      canvasContainer.className = 'chart-canvas-wrapper';
      
      var canvas = document.createElement('canvas');
      canvas.id = 'practice-chart';
      
      canvasContainer.appendChild(canvas);
      graphContainer.appendChild(graphTitle);
      graphContainer.appendChild(canvasContainer);
      content.appendChild(graphContainer);
      
      // Stats Cards
      var statsCards = document.createElement('div');
      statsCards.className = 'stats-grid';
      
      var stats = [
        { label: 'Total Time', id: 'stat-total-time', value: '‚Äî' },
        { label: 'Avg. Session', id: 'stat-avg-time', value: '‚Äî' }
      ];
      
      stats.forEach(function(stat){
        var box = document.createElement('div');
        box.className = 'stat-card';
        
        var labelEl = document.createElement('div');
        labelEl.className = 'stat-label';
        labelEl.textContent = stat.label;
        
        var progressEl = document.createElement('div');
        progressEl.className = 'stat-value';
        progressEl.id = stat.id;
        progressEl.textContent = stat.value;
        
        box.appendChild(labelEl);
        box.appendChild(progressEl);
        statsCards.appendChild(box);
      });
      
      content.appendChild(statsCards);
      
      // Recent Practice Timeline
      var timelineContainer = document.createElement('div');
      timelineContainer.id = 'recent-practice-timeline';
      content.appendChild(timelineContainer);
      
      loadStatsAndChart(user, canvas);
      
      return content;
    }
    
    function loadStatsAndChart(user, canvas){
      if (!user) return;
      
      // Load practice stats
      db.collection('users').doc(user.uid).collection('practice').doc('stats').get()
        .then(function(snap){
          if (!snap.exists) {
            console.log('[Stats] No stats document found yet');
            return;
          }
          var data = snap.data() || {};
          
          // Total time
          var totalSeconds = data.totalSeconds || 0;
          var totalEl = document.getElementById('stat-total-time');
          if (totalEl) {
            totalEl.textContent = formatDuration(totalSeconds);
          }
          
          // Avg per session
          var sessionCount = data.sessionCount || 0;
          var avgEl = document.getElementById('stat-avg-time');
          if (avgEl) {
            if (totalSeconds > 0 && sessionCount > 0) {
              avgEl.textContent = formatDuration(Math.round(totalSeconds / sessionCount));
            } else {
              avgEl.textContent = '0 min';
            }
          }
        })
        .catch(function(err){
          console.error('[Stats] Error loading stats:', err);
          window.VaultToast.error('Failed to load stats');
        });
      
      // Load and render 30-day chart
      load30DayChart(user, canvas);
      
      // Load recent practice timeline
      loadRecentPracticeTimeline(user);
    }
    
    function load30DayChart(user, canvas){
      if (!user || !canvas) return;
      
      // Get date 30 days ago
      var today = new Date();
      var thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 29); // -29 to include today = 30 days total
      
      // Query last 30 days of practice sessions
      db.collection('users').doc(user.uid).collection('practice').doc('sessions')
        .collection('items')
        .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(thirtyDaysAgo))
        .get()
        .then(function(snap){
          // Build data structure: date -> minutes
          var dataByDate = {};
          snap.forEach(function(doc){
            var data = doc.data();
            var seconds = data.duration || 0;
            var minutes = Math.round(seconds / 60);
            var date = data.date; // YYYY-MM-DD format
            if (date) {
              dataByDate[date] = (dataByDate[date] || 0) + minutes;
            }
          });
          
          // Build arrays for chart (last 30 days)
          var labels = [];
          var dataPoints = [];
          
          for (var i = 29; i >= 0; i--) {
            var d = new Date(today);
            d.setDate(today.getDate() - i);
            
            var dateKey = d.getFullYear() + '-' + 
              String(d.getMonth() + 1).padStart(2, '0') + '-' + 
              String(d.getDate()).padStart(2, '0');
            
            // Label: show date every 5 days, otherwise empty
            var dayOfMonth = d.getDate();
            var label = '';
            if (i === 29 || i === 0 || dayOfMonth % 5 === 0) {
              label = dayOfMonth + '/' + (d.getMonth() + 1); // DD/MM format
            }
            labels.push(label);
            
            dataPoints.push(dataByDate[dateKey] || 0);
          }
          
          // Render chart with Chart.js
          renderPracticeChart(canvas, labels, dataPoints);
        })
        .catch(function(e){
          console.error('Failed to load chart data:', e);
          window.VaultToast.error('Failed to load chart data');
        });
    }
    
    function renderPracticeChart(canvas, labels, dataPoints){
      // Check if Chart.js is loaded
      if (typeof Chart === 'undefined') {
        var msg = document.createElement('div');
        msg.style.cssText = 'text-align:center;padding:40px;color:#999;';
        msg.textContent = 'Chart library not loaded.';
        canvas.parentNode.replaceChild(msg, canvas);
        return;
      }
      
      var ctx = canvas.getContext('2d');
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Minutes',
            data: dataPoints,
            backgroundColor: '#06b3fd',
            borderColor: '#06b3fd',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                title: function(items) {
                  // Show full date on hover
                  var index = items[0].dataIndex;
                  var today = new Date();
                  var d = new Date(today);
                  d.setDate(today.getDate() - (29 - index));
                  return d.toLocaleDateString('en-AU', { 
                    weekday: 'short', 
                    month: 'short', 
                    day: 'numeric' 
                  });
                },
                label: function(context) {
                  var mins = context.parsed.y;
                  if (mins === 0) return 'No practice';
                  if (mins < 60) return mins + ' min';
                  var hrs = Math.floor(mins / 60);
                  var rem = mins % 60;
                  return rem === 0 ? hrs + ' hrs' : hrs + ' hrs ' + rem + ' min';
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 10
                }
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                maxTicksLimit: 5,
                callback: function(value) {
                  return value + 'm';
                },
                font: {
                  size: 10
                }
              },
              grid: {
                color: '#f0f0f0'
              }
            }
          }
        }
      });
    }
    
    function loadRecentPracticeTimeline(user){
      var container = document.getElementById('recent-practice-timeline');
      if (!container || !user) return;
      
      // Load last 5 practice sessions
      db.collection('users').doc(user.uid).collection('practice')
        .doc('sessions').collection('items')
        .orderBy('timestamp', 'desc')
        .limit(5)
        .get()
        .then(function(snap){
          if (snap.empty) {
            container.innerHTML = '';
            return;
          }
          
          // Group sessions by date
          var sessionsByDate = {};
          snap.forEach(function(doc){
            var data = doc.data();
            var date = data.date; // YYYY-MM-DD
            if (!date) return;
            
            if (!sessionsByDate[date]) {
              sessionsByDate[date] = [];
            }
            sessionsByDate[date].push(data);
          });
          
          // Render timeline
          container.innerHTML = '';
          
          var header = document.createElement('div');
          header.className = 'sessions-header';
          header.textContent = 'RECENT PRACTICE';
          container.appendChild(header);
          
          var timeline = document.createElement('div');
          timeline.className = 'timeline';
          
          // Get dates in order
          var dates = Object.keys(sessionsByDate).sort().reverse();
          
          dates.forEach(function(dateKey){
            var sessions = sessionsByDate[dateKey];
            
            var dateGroup = document.createElement('div');
            dateGroup.className = 'timeline-date';
            
            var dateLabel = document.createElement('div');
            dateLabel.className = 'date-label';
            dateLabel.textContent = formatDateLabel(dateKey);
            dateGroup.appendChild(dateLabel);
            
            sessions.forEach(function(session){
              var item = document.createElement('div');
              item.className = 'timeline-item';
              
              var lesson = document.createElement('div');
              lesson.className = 'timeline-lesson';
              var icon = getPathwayIcon(session.courseId);
              lesson.textContent = icon + ' ' + (session.lessonTitle || 'Practice Session');
              item.appendChild(lesson);
              
              var duration = document.createElement('div');
              duration.className = 'timeline-duration';
              var mins = Math.round((session.duration || 0) / 60);
              duration.textContent = mins + ' min';
              item.appendChild(duration);
              
              if (session.notes && session.notes.trim()) {
                var notes = document.createElement('div');
                notes.className = 'timeline-notes';
                notes.textContent = '"' + session.notes + '"';
                item.appendChild(notes);
              }
              
              dateGroup.appendChild(item);
            });
            
            timeline.appendChild(dateGroup);
          });
          
          container.appendChild(timeline);
          
          var viewAll = document.createElement('a');
          viewAll.href = '#';
          viewAll.className = 'view-all';
          viewAll.textContent = 'View All ‚Üí';
          viewAll.onclick = function(e){
            e.preventDefault();
            // Future: link to full session history page
          };
          container.appendChild(viewAll);
        })
        .catch(function(err){
          console.error('Failed to load recent practice:', err);
          window.VaultToast.error('Failed to load recent practice');
        });
    }
    
    // Create Goals Content
    function createGoalsContent(user){
      var content = document.createElement('div');
      
      var textarea = document.createElement('textarea');
      textarea.id = 'goals-textarea';
      textarea.placeholder = 'Write your practice goals here...';
      textarea.maxLength = 250;
      textarea.style.cssText = 'width:100%;min-height:120px;padding:12px;border:1px solid #ddd;' +
        'border-radius:6px;font-family:inherit;font-size:14px;resize:vertical;box-sizing:border-box;';
      
      var footer = document.createElement('div');
      footer.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-top:8px;' +
        'font-size:12px;color:#666;';
      
      var charCount = document.createElement('span');
      charCount.id = 'goals-char-count';
      charCount.textContent = '0/250';
      
      var timestamp = document.createElement('span');
      timestamp.id = 'goals-timestamp';
      timestamp.style.opacity = '0.75';
      timestamp.textContent = '';
      
      footer.appendChild(timestamp);
      footer.appendChild(charCount);
      
      content.appendChild(textarea);
      content.appendChild(footer);
      
      // Load existing goals
      db.collection('users').doc(user.uid).collection('metrics').doc('practice').get()
        .then(function(snap){
          if (!snap.exists) return;
          var data = snap.data() || {};
          
          if (data.goalsText) {
            textarea.value = data.goalsText;
            charCount.textContent = data.goalsText.length + '/250';
          }
          
          if (data.goalsUpdatedAt && data.goalsUpdatedAt.toDate) {
            var d = data.goalsUpdatedAt.toDate();
            timestamp.textContent = 'Last edited: ' + d.toLocaleDateString('en-AU', {
              day: 'numeric',
              month: 'short',
              year: 'numeric'
            });
          }
        })
        .catch(function(e){
          console.error('Failed to load goals:', e);
        });
      
      // Character counter
      textarea.addEventListener('input', function(){
        var len = textarea.value.length;
        charCount.textContent = len + '/250';
        
        if (len > 250) {
          charCount.style.color = '#c00';
        } else {
          charCount.style.color = '#666';
        }
      });
      
      // Auto-save on blur with debounce
      var saveTimeout;
      textarea.addEventListener('blur', function(){
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(function(){
          saveGoals(user, textarea.value, timestamp);
        }, 300);
      });
      
      return content;
    }
    
    function saveGoals(user, text, timestampEl){
      if (!user) return;
      
      db.collection('users').doc(user.uid).collection('metrics').doc('practice').set({
        goalsText: text,
        goalsUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true })
        .then(function(){
          var now = new Date();
          timestampEl.textContent = 'Last edited: ' + now.toLocaleDateString('en-AU', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
          });
          
          // Show brief saved indicator
          var savedMsg = document.createElement('span');
          savedMsg.textContent = ' ‚úì Saved';
          savedMsg.style.color = '#0a0';
          savedMsg.style.marginLeft = '8px';
          timestampEl.appendChild(savedMsg);
          
          setTimeout(function(){
            savedMsg.remove();
          }, 2000);
        })
        .catch(function(e){
          console.error('Failed to save goals:', e);
          window.VaultToast.error('Failed to save goals');
        });
    }
    
    // Helper functions
    function formatDateLabel(dateKey){
      var today = new Date();
      var yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      var todayKey = today.getFullYear() + '-' + 
        String(today.getMonth() + 1).padStart(2, '0') + '-' + 
        String(today.getDate()).padStart(2, '0');
      
      var yesterdayKey = yesterday.getFullYear() + '-' + 
        String(yesterday.getMonth() + 1).padStart(2, '0') + '-' + 
        String(yesterday.getDate()).padStart(2, '0');
      
      if (dateKey === todayKey) return 'Today';
      if (dateKey === yesterdayKey) return 'Yesterday';
      
      // Parse date and format as "Dec 28"
      var parts = dateKey.split('-');
      var d = new Date(parts[0], parts[1] - 1, parts[2]);
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[d.getMonth()] + ' ' + d.getDate();
    }
    
    function getPathwayIcon(courseId){
      if (!courseId) return 'ü•Å';
      var pathway = courseId.substring(0, 2);
      if (pathway === 'gs') return 'ü•Å';
      if (pathway === 'fs') return 'üéµ';
      if (pathway === 'rs') return 'üìñ';
      if (pathway === 'ss') return 'ü•¢';
      if (pathway === 'ks') return 'ü¶∂';
      return 'ü•Å';
    }
    
    function formatDuration(sec){
      sec = Number(sec || 0);
      if (sec <= 0) return '0 min';
      var mins = Math.round(sec / 60);
      if (mins < 60) return mins + ' min';
      var hours = Math.floor(mins / 60);
      var rem = mins % 60;
      return rem === 0 ? hours + ' hrs' : hours + ' hrs ' + rem + ' min';
    }
    
    // Start when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForFirebase);
    } else {
      waitForFirebase();
    }
  })();
  </script>
  
</body>
</html>
