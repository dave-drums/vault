<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Groove Studies | Practice Vault</title>
  
  <!-- Firebase SDK -->
  <script src="firebase/firebase-app-compat.js"></script>
  <script src="firebase/firebase-auth-compat.js"></script>
  <script src="firebase/firebase-firestore-compat.js"></script>
  <script src="firebase/firebase-functions-compat.js"></script>
  <script src="firebase/firebase-storage-compat.js"></script>
  
  <!-- Firebase Init -->
  <script>
    if (typeof firebase !== 'undefined' && !firebase.apps.length) {
      firebase.initializeApp({
        apiKey: "AIzaSyDfiWX_TGcCopulONaTFBIaPb7ZRAiC_dc",
        authDomain: "dave-drums.firebaseapp.com",
        projectId: "dave-drums",
        storageBucket: "dave-drums.firebasestorage.app",
        messagingSenderId: "602823096344",
        appId: "1:602823096344:web:b6402156a4d1c16a21ab6d",
        measurementId: "G-RHL1DSNTJ7"
      });
    }
  </script>
  
  <!-- Auth Protection -->
  <script>
    document.documentElement.dataset.protected = 'true';
  </script>
  
  <!-- Vault Components -->
  <script src="vault-components.js"></script>
  <script src="vault-course-config.js"></script>
  
  <!-- Vault Renderer Config -->
  <script>
    window.VAULT_CONFIG = {
      bunnyLibraryId: "556221",
      grooveOrigin: "https://groove.davedrums.com.au",
      grooveEmbedPath: "/GrooveEmbed.html",
      youtubeLogoSrc: "youtube-logo.png"
    };
  </script>
  <script src="vault-render.js" defer></script>
  
  <!-- Lesson Comments -->
  <script src="vault-lesson-comments.js" defer></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #242424;
      --bg-tertiary: #2e2e2e;
      --text-primary: #e8e8e8;
      --text-secondary: #b8b8b8;
      --accent: #06b3fd;
      --accent-hover: #0599dc;
      --border: #3a3a3a;
      --vault-bubble-bg: #242424;
    }
    
    html[data-protected="true"] body {
      opacity: 0;
      transition: opacity .2s ease;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    /* Course Container Styles (Dark Theme) */
    .course-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .course-container p {
      margin: 0;
    }
    
    .course-progress-section {
      margin-bottom: 40px;
    }
    
    .course-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      color: var(--text-primary);
    }
    
    .course-progress-bar-bg {
      width: 100%;
      height: 17px;
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    
    .course-progress-bar-fill {
      height: 100%;
      background-color: var(--accent);
      border-radius: 13px;
      transition: width 0.3s ease;
    }
    
    .course-chapter {
      margin-bottom: 50px;
    }
    
    .course-chapter-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .course-chapter-title {
      margin: 0;
      color: var(--text-primary);
    }
    
    .course-lessons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }
    
    .course-lesson-item {
      background-color: var(--bg-secondary);
      padding: 20px 24px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
      border: 1px solid var(--border);
    }
    
    .course-lesson-item:hover {
      background-color: var(--bg-tertiary);
      border-color: var(--accent);
    }
    
    .course-lesson-link {
      flex: 1;
      user-select: none;
      color: var(--text-primary);
    }
    
    .course-lesson-status {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s ease;
    }
    
    .course-lesson-status.completed {
      background-color: var(--accent);
      border-color: var(--accent);
    }
    
    .course-lesson-status.completed::after {
      content: '✓';
      color: white;
      font-size: 16px;
      font-weight: bold;
    }
    
    .course-lesson-status.incomplete {
      background-color: var(--bg-tertiary);
      border: 2px solid var(--border);
    }
    
    /* Lesson View Styles (Dark Theme) */
    #lesson-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .lesson-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      gap: 16px;
    }
    
    .btn-secondary {
      padding: 12px 24px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .btn-secondary:hover {
      background: var(--bg-tertiary);
    }
    
    .btn-primary {
      padding: 12px 24px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary:hover {
      background: var(--accent-hover);
    }
    
    /* Vault Render Overrides for Dark Theme */
    .vault-info {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border);
      color: var(--text-primary) !important;
    }
    
    .vault-heading {
      color: var(--text-primary) !important;
    }
    
    .vault-divider {
      background: var(--border) !important;
    }
    
    .vault-groove-player {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border) !important;
    }
    
    /* Comments Section (Dark Theme) */
    .vault-comments {
      width: min(860px, 100%);
      margin: 40px auto 0;
      padding: 24px;
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border) !important;
      border-radius: 12px;
      color: var(--text-primary) !important;
    }
    
    .vault-comments h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      color: var(--text-primary) !important;
    }
    
    #vault-comment-text {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border) !important;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
      margin-bottom: 8px;
      font-family: inherit;
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    #vault-comment-text::placeholder {
      color: var(--text-secondary);
    }
    
    #vault-comment-post {
      padding: 10px 20px;
      background: var(--accent) !important;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    
    #vault-comment-post:hover {
      background: var(--accent-hover) !important;
    }
    
    .vault-comment {
      padding: 16px;
      border-bottom: 1px solid var(--border) !important;
      margin-bottom: 8px;
    }
    
    .vault-comment-author {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary) !important;
    }
    
    .vault-comment-time {
      font-size: 12px;
      color: var(--text-secondary) !important;
      margin-bottom: 8px;
    }
    
    .vault-comment-text {
      line-height: 1.6;
      margin-bottom: 8px;
      color: var(--text-primary) !important;
    }
    
    .vault-comment-actions {
      display: flex;
      gap: 12px;
      font-size: 13px;
    }
    
    .vault-comment-actions button {
      background: none;
      border: none;
      color: var(--accent);
      cursor: pointer;
      padding: 0;
      font-size: 12px;
    }
    
    .vault-comment-actions button:hover {
      text-decoration: underline;
    }
    
    .vault-comment-reply {
      margin-left: 40px;
      border-left: 2px solid var(--border);
      padding-left: 16px;
    }
    
    @media (max-width: 768px) {
      .course-lessons-grid {
        grid-template-columns: 1fr;
      }
      
      .lesson-buttons {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn-secondary,
      .btn-primary {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <!-- Auth check -->
  <script>
    (function(){
      var revealed = false;
      function reveal(){
        if (revealed) return;
        revealed = true;
        if (document.body) document.body.style.opacity = '1';
      }
      function redirectToMembers(){
        var next = encodeURIComponent(location.pathname + location.search + location.hash);
        location.href = 'members.html?next=' + next;
      }
      var failSafe = setTimeout(reveal, 2500);
      
      if (typeof firebase !== 'undefined' && firebase.auth) {
        firebase.auth().onAuthStateChanged(function(user){
          clearTimeout(failSafe);
          if (!user) {
            redirectToMembers();
          } else {
            reveal();
          }
        });
      }
    })();
  <script>
(function() {
  'use strict';
  
  const urlParams = new URLSearchParams(window.location.search);
  const lessonId = urlParams.get('l');
  
  // Extract courseId from URL: /vault/gs?c=1 → gs1
  const path = window.location.pathname;
  const pathParts = path.split('/').filter(p => p.length > 0);
  const pathway = (pathParts.length >= 2 && pathParts[0] === 'vault') ? pathParts[1] : null;
  const courseNum = urlParams.get('c');
  const courseId = (pathway && courseNum) ? pathway + courseNum : null;
  
  if (!courseId) {
    document.getElementById('course-index').innerHTML = 
      '<div style="text-align:center;padding:40px;color:#c00;">Invalid course URL</div>';
    return;
  }
  
  // Check if course exists in config
  const courseConfig = window.VAULT_COURSES && window.VAULT_COURSES[courseId];
  if (!courseConfig) {
    document.getElementById('course-index').innerHTML = 
      '<div style="text-align:center;padding:40px;color:#c00;">Course "' + courseId + '" not found</div>';
    return;
  }
  
  if (lessonId) {
    // Show individual lesson
    document.getElementById('course-index').style.display = 'none';
    document.getElementById('lesson-content').style.display = 'block';
    
    // Wait for Firebase to be fully initialized
    waitForFirebase(function() {
      loadLesson(courseId, lessonId);
    });
  } else {
    // Show course index
    waitForFirebase(function() {
      loadCourseIndex(courseId, courseConfig);
    });
  }
  
  function waitForFirebase(callback) {
    var attempts = 0;
    var maxAttempts = 300; // 30 seconds
    
    var checkFirebase = setInterval(function() {
      attempts++;
      
      // Check if Firebase is loaded AND initialized
      if (typeof firebase !== 'undefined' && 
          firebase.apps && 
          firebase.apps.length > 0 &&
          firebase.auth &&
          firebase.storage) {
        console.log('[Firebase] Ready!');
        clearInterval(checkFirebase);
        callback();
        return;
      }
      
      if (attempts >= maxAttempts) {
        console.error('[Firebase] Timeout waiting for initialization');
        clearInterval(checkFirebase);
        document.getElementById('course-index').innerHTML = 
          '<div style="text-align:center;padding:40px;">' +
          '<h3 style="color:#c00;margin-bottom:12px;">Connection Issue</h3>' +
          '<p style="color:#666;margin-bottom:16px;">Unable to load course content. This may be caused by:</p>' +
          '<ul style="text-align:left;max-width:400px;margin:0 auto 16px;color:#666;">' +
          '<li>Ad blocker or privacy extension</li>' +
          '<li>Slow internet connection</li>' +
          '<li>Browser firewall settings</li>' +
          '</ul>' +
          '<button onclick="location.reload()" style="padding:10px 20px;background:#06b3fd;color:#fff;border:none;border-radius:6px;cursor:pointer;">Retry</button>' +
          '</div>';
      }
    }, 100);
  }
  
  // ============================================
  // COURSE INDEX RENDERER
  // ============================================
  
  function loadCourseIndex(courseId, courseConfig) {
    console.log('[Course Index] Loading:', courseId, courseConfig);
    
    if (!courseConfig.lessons || courseConfig.lessons.length === 0) {
      document.getElementById('course-index').innerHTML = 
        '<div style="text-align:center;padding:40px;"><h2>' + courseConfig.name + '</h2>' +
        '<p style="color:#666;margin-top:12px;">Coming soon...</p></div>';
      return;
    }
    
    firebase.auth().onAuthStateChanged(function(user) {
      console.log('[Course Index] Auth state:', user ? user.uid : 'not logged in');
      
      if (!user) {
        document.getElementById('course-index').innerHTML = 
          '<div style="text-align:center;padding:40px;color:#c00;">Please log in to view courses</div>';
        return;
      }
      
      console.log('[Course Index] Fetching course file:', courseId + '.txt');
      
      try {
        const storage = firebase.storage();
        const fileRef = storage.ref('courses/' + courseId + '.txt');
        
        fileRef.getDownloadURL()
          .then(function(url) {
            console.log('[Course Index] Got download URL, fetching...');
            return fetch(url);
          })
          .then(function(response) {
            console.log('[Course Index] Fetch response:', response.status);
            return response.text();
          })
          .then(function(fileContent) {
            console.log('[Course Index] Parsing structure...');
            const structure = parseCourseStructure(fileContent, courseConfig.lessons);
            console.log('[Course Index] Structure:', structure);
            renderCourseIndex(courseId, courseConfig, structure, user.uid);
          })
          .catch(function(error) {
            console.error('[Course Index] Error:', error);
            // Fallback: render without chapters
            console.log('[Course Index] Falling back to simple render');
            renderCourseIndex(courseId, courseConfig, {
              chapters: [{title: 'Lessons', lessons: courseConfig.lessons}], 
              lessonTitles: {}
            }, user.uid);
          });
      } catch(error) {
        console.error('[Course Index] Firebase Storage error:', error);
        document.getElementById('course-index').innerHTML = 
          '<div style="text-align:center;padding:40px;color:#c00;">Error loading course. Please refresh the page.</div>';
      }
    });
  }
  
  function parseCourseStructure(fileContent, lessonIds) {
    const lines = fileContent.split(/\r?\n/);
    const chapters = [];
    let currentChapter = null;
    
    const lessonTitles = {};
    
    lines.forEach(line => {
      const trimmed = line.trim();
      
      // Chapter marker: === CHAPTER | Title ===
      const chapterMatch = trimmed.match(/^===\s*CHAPTER\s*\|\s*(.+?)\s*===$/);
      if (chapterMatch) {
        if (currentChapter) {
          chapters.push(currentChapter);
        }
        currentChapter = {
          title: chapterMatch[1],
          lessons: []
        };
        return;
      }
      
      // Lesson marker: === LESSON | G1.01 Start Here ===
      const lessonMatch = trimmed.match(/^===\s*LESSON\s*\|\s*(.+?)\s*===$/);
      if (lessonMatch) {
        const fullTitle = lessonMatch[1]; // "G1.01 Start Here"
        
        // Extract lesson ID from title (G1.01, F2.05, etc.)
        const idMatch = fullTitle.match(/^([A-Z]+\d+\.\d+)/);
        if (idMatch) {
          const lessonId = idMatch[1].replace(/^[A-Z]+/, ''); // G1.01 → 1.01
          lessonTitles[lessonId] = fullTitle;
          
          if (currentChapter) {
            currentChapter.lessons.push(lessonId);
          }
        }
      }
    });
    
    // Add last chapter
    if (currentChapter) {
      chapters.push(currentChapter);
    }
    
    // If no chapters found, create single chapter with all lessons
    if (chapters.length === 0) {
      chapters.push({
        title: 'Lessons',
        lessons: lessonIds
      });
    }
    
    return { chapters, lessonTitles };
  }
  
  function renderCourseIndex(courseId, courseConfig, structure, uid) {
    console.log('[Render] Starting render for:', courseId);
    console.log('[Render] Structure:', structure);
    console.log('[Render] Config:', courseConfig);
    
    const container = document.getElementById('course-index');
    
    if (!container) {
      console.error('[Render] Container #course-index not found!');
      return;
    }
    
    let html = '';
    
    // Back to Vault button
    html += '<div style="margin-bottom:24px;">';
    html += '<a href="/vault" style="display:inline-block;padding:10px 16px;background:#f3f3f3;border:1px solid #ddd;border-radius:6px;text-decoration:none;color:#333;transition:all 0.2s;font-size:14px;" onmouseover="this.style.background=\'#e8e8e8\'" onmouseout="this.style.background=\'#f3f3f3\'">← Back to Practice Vault</a>';
    html += '</div>';
    
    // Progress section
    html += '<div class="course-progress-section">';
    html += '<div class="course-progress-header">';
    html += '<p class="sqsrte-medium course-progress-text">0/' + courseConfig.lessons.length + ' (0%)</p>';
    html += '<p class="sqsrte-lmedium">Progress</p>';
    html += '</div>';
    html += '<div class="course-progress-bar-bg">';
    html += '<div class="course-progress-bar-fill course-progress-bar" style="width: 0%;"></div>';
    html += '</div>';
    html += '</div>';
    
    // Chapters
    structure.chapters.forEach(chapter => {
      html += '<div class="course-chapter">';
      html += '<div class="course-chapter-header">';
      html += '<p class="course-chapter-title sqsrte-large">' + escapeHtml(chapter.title) + '</p>';
      html += '<span class="course-chapter-count">' + chapter.lessons.length + ' Lesson' + (chapter.lessons.length !== 1 ? 's' : '') + '</span>';
      html += '</div>';
      html += '<div class="course-lessons-grid">';
      
      chapter.lessons.forEach(lessonId => {
        const lessonTitle = structure.lessonTitles[lessonId] || ('Lesson ' + lessonId);
        
        html += '<div class="course-lesson-item" data-lesson="' + escapeHtml(lessonId) + '">';
        html += '<div class="course-lesson-link sqsrte-small">' + escapeHtml(lessonTitle) + '</div>';
        html += '<div class="course-lesson-status incomplete"></div>';
        html += '</div>';
      });
      
      html += '</div>';
      html += '</div>';
    });
    
    container.innerHTML = html;
    
    // Attach click handlers to lesson items
    const lessonItems = container.querySelectorAll('.course-lesson-item');
    lessonItems.forEach(item => {
      const lessonId = item.getAttribute('data-lesson');
      item.onclick = function() {
        const parsed = courseId.match(/^([a-z]+)(\d+)$/);
        if (parsed) {
          window.location.href = ' + parsed[1] + '?c=' + parsed[2] + '&l=' + lessonId;
        }
      };
    });
    
    // Load progress data and update UI
    loadAndDisplayProgress(uid, courseId, courseConfig);
    
    // Set page title
    document.title = courseConfig.name + ' | Dave Drums Practice Vault';
  }
  
  function loadAndDisplayProgress(uid, courseId, courseConfig) {
    const db = firebase.firestore();
    db.collection('users').doc(uid).collection('progress').doc(courseId).get()
      .then(function(snap) {
        const completed = (snap.exists && snap.data().completed) ? snap.data().completed : {};
        
        // Update checkboxes
        Object.keys(completed).forEach(function(lessonId) {
          if (completed[lessonId] === true) {
            const item = document.querySelector('.course-lesson-item[data-lesson="' + lessonId + '"]');
            if (item) {
              const status = item.querySelector('.course-lesson-status');
              if (status) {
                status.classList.remove('incomplete');
                status.classList.add('completed');
              }
            }
          }
        });
        
        // Update progress bar
        const totalLessons = courseConfig.lessons.length;
        const completedCount = Object.keys(completed).filter(function(k) { return completed[k] === true; }).length;
        const percent = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0;
        
        const progressText = document.querySelector('.course-progress-text');
        const progressBar = document.querySelector('.course-progress-bar');
        
        if (progressText) {
          progressText.textContent = completedCount + '/' + totalLessons + ' (' + percent + '%)';
        }
        if (progressBar) {
          progressBar.style.width = percent + '%';
        }
      })
      .catch(function(err) {
        console.error('Error loading progress:', err);
      });
  }
  
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  
  // ============================================
  // LESSON RENDERER (existing code)
  // ============================================
  
  async function loadLesson(course, lesson) {
    var user = firebase.auth().currentUser;
    
    if (user) {
      await fetchAndRenderLesson(user, course, lesson);
    } else {
      firebase.auth().onAuthStateChanged(async function(user) {
        if (!user) {
          showError('You must be logged in to view lessons.');
          return;
        }
        await fetchAndRenderLesson(user, course, lesson);
      });
    }
  }
  
  async function fetchAndRenderLesson(user, course, lesson) {
      try {
        const storage = firebase.storage();
        const fileRef = storage.ref(`courses/${course}.txt`);
        const downloadUrl = await fileRef.getDownloadURL();
        const response = await fetch(downloadUrl);
        
        if (!response.ok) {
          showError(`Failed to fetch ${course}.txt (HTTP ${response.status})`);
          return;
        }
        
        const fileContent = await response.text();
        const extracted = extractLesson(fileContent, lesson);
        
        if (!extracted) {
          const available = extractAllLessonIds(fileContent);
          showError(`Lesson "${lesson}" not found. Available: ${available.join(', ')}`);
          return;
        }
        
        renderLesson(extracted.content, extracted.title, course);
        
      } catch (error) {
        showError(`Error: ${error.message}`);
        console.error(error);
      }
  }
  
  function extractAllLessonIds(content) {
    content = content.replace(/\r\n/g, '\n');
    const headerRegex = /^===\s*LESSON\s*\|\s*(.+?)\s*===\s*$/gm;
    const ids = [];
    let match;
    while ((match = headerRegex.exec(content)) !== null) {
      const fullTitle = match[1];
      const idMatch = fullTitle.match(/^[A-Z]+(\d+\.\d+)/);
      if (idMatch) {
        ids.push(idMatch[1]);
      }
    }
    return ids;
  }
  
  function extractLesson(content, lessonId) {
    content = content.replace(/\r\n/g, '\n');
    const targetId = lessonId.trim();
    const headerRegex = /^===\s*LESSON\s*\|\s*(.+?)\s*===\s*$/gm;
    
    const headers = [];
    let match;
    
    while ((match = headerRegex.exec(content)) !== null) {
      const fullTitle = match[1]; // "G1.01 Start Here"
      
      // Extract lesson ID from title
      const idMatch = fullTitle.match(/^[A-Z]+(\d+\.\d+)/);
      if (idMatch) {
        headers.push({
          id: idMatch[1], // 1.01
          title: fullTitle, // G1.01 Start Here
          startPos: match.index,
          headerEndPos: match.index + match[0].length
        });
      }
    }
    
    const targetIndex = headers.findIndex(h => h.id === targetId);
    if (targetIndex === -1) return null;
    
    const targetHeader = headers[targetIndex];
    const start = targetHeader.headerEndPos;
    const end = headers[targetIndex + 1]?.startPos ?? content.length;
    
    const lessonContent = content.substring(start, end).trim();
    const lessonTitle = targetHeader.title;
    
    return { content: lessonContent, title: lessonTitle };
  }
  
  function renderLesson(content, title, courseId, attempt) {
    attempt = attempt || 0;
    
    if (!window.vaultParse) {
      if (attempt < 50) {
        setTimeout(function() { renderLesson(content, title, courseId, attempt + 1); }, 100);
      } else {
        showError('Failed to load lesson renderer. Please refresh the page.');
      }
      return;
    }
    
    const tokens = window.vaultParse.tokenise(content);
    const renderedDOM = window.vaultParse.render(tokens);
    
    const container = document.getElementById('lesson-content');
    container.innerHTML = '';
    
    const buttonContainer = document.createElement('div');
    buttonContainer.style.cssText = 'width:min(860px,100%);margin:0 auto 40px;display:flex;justify-content:space-between;align-items:flex-start;';
    
    const backBtn = document.createElement('a');
    backBtn.href = ' + pathway + '?c=' + courseNum;
    backBtn.textContent = '← Back to Course';
    backBtn.className = 'p3';
    backBtn.style.cssText = 'display:inline-block;padding:10px 16px;background:#f3f3f3;' +
      'border:1px solid #ddd;border-radius:6px;text-decoration:none;color:#333;transition:all 0.2s;' +
      'font-size:14px;';
    backBtn.addEventListener('mouseenter', function(){ backBtn.style.background = '#e8e8e8'; });
    backBtn.addEventListener('mouseleave', function(){ backBtn.style.background = '#f3f3f3'; });
    buttonContainer.appendChild(backBtn);
    
    const topButtonPlaceholder = document.createElement('div');
    topButtonPlaceholder.id = 'complete-button-top';
    buttonContainer.appendChild(topButtonPlaceholder);
    
    container.appendChild(buttonContainer);
    container.appendChild(renderedDOM);
    
    const bottomButtonPlaceholder = document.createElement('div');
    bottomButtonPlaceholder.id = 'complete-button-bottom';
    bottomButtonPlaceholder.style.cssText = 'width:min(860px,100%);margin:40px auto 0;text-align:right;';
    
    const commentsHTML = `
      <div id="vault-comments" class="vault-comments">
        <h3>Lesson Comments</h3>
        <div id="vault-comments-meta" style="font-size:14px;color:#666;margin-bottom:16px;"></div>
        <div id="vault-comments-list" style="margin-bottom:24px;"></div>
        <form id="vault-comment-form">
          <textarea id="vault-comment-text" placeholder="Add a comment..."></textarea>
          <div style="display:flex;justify-content:flex-end;">
            <button type="submit" id="vault-comment-post">Post Comment</button>
          </div>
        </form>
        <div id="vault-comment-status" style="margin:8px 0;color:#c00;font-size:14px;"></div>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', commentsHTML);
    
    const courseConfig = window.VAULT_COURSES && window.VAULT_COURSES[courseId];
    const courseName = courseConfig ? courseConfig.name : courseId.toUpperCase();
    document.title = title + ' | ' + courseName;
    
    if (window.VaultAudioPlayer?.scan) {
      window.VaultAudioPlayer.scan();
    }
    
    // Create complete buttons
    createCompleteButtons(courseId, lessonId);
    
    setTimeout(function() {
      if (typeof window.initVaultComments === 'function') {
        window.initVaultComments();
      }
    }, 200);
  }
  
  function createCompleteButtons(courseId, lessonId) {
    firebase.auth().onAuthStateChanged(function(user) {
      if (!user) return;
      
      const db = firebase.firestore();
      const courseConfig = window.VAULT_COURSES[courseId];
      if (!courseConfig || !courseConfig.lessons) return;
      
      const currentIndex = courseConfig.lessons.indexOf(lessonId);
      if (currentIndex === -1) return;
      
      const nextLessonId = courseConfig.lessons[currentIndex + 1];
      
      // Check selfProgress setting
      db.collection('users').doc(user.uid).get()
        .then(function(doc) {
          const userData = doc.exists ? doc.data() : {};
          const selfProgress = userData.selfProgress === true;
          
          const buttonText = selfProgress ? 'Complete Lesson →' : 'Next Lesson →';
          const buttonAction = selfProgress ? 'complete' : 'next';
          
          // Create click handler function (reusable)
          const handleClick = function() {
            if (selfProgress && nextLessonId) {
              // Mark as complete, then navigate
              markLessonComplete(user.uid, courseId, lessonId).then(function() {
                navigateToLesson(courseId, nextLessonId);
              });
            } else if (nextLessonId) {
              // Just navigate
              navigateToLesson(courseId, nextLessonId);
            } else {
              // Last lesson - go back to course
              const parsed = courseId.match(/^([a-z]+)(\d+)$/);
              if (parsed) {
                window.location.href = ' + parsed[1] + '?c=' + parsed[2];
              }
            }
          };
          
          // Create top button
          const topBtn = document.createElement('button');
          topBtn.textContent = nextLessonId ? buttonText : (selfProgress ? 'Complete Course' : 'Back to Course');
          topBtn.style.cssText = 'padding:12px 24px;background:#06b3fd;color:#fff;border:none;' +
            'border-radius:8px;cursor:pointer;font-size:15px;font-weight:500;transition:background 0.2s;';
          topBtn.addEventListener('mouseenter', function(){ topBtn.style.background = '#0599dc'; });
          topBtn.addEventListener('mouseleave', function(){ topBtn.style.background = '#06b3fd'; });
          topBtn.addEventListener('click', handleClick);
          
          // Create bottom button
          const bottomBtn = document.createElement('button');
          bottomBtn.textContent = nextLessonId ? buttonText : (selfProgress ? 'Complete Course' : 'Back to Course');
          bottomBtn.style.cssText = 'padding:12px 24px;background:#06b3fd;color:#fff;border:none;' +
            'border-radius:8px;cursor:pointer;font-size:15px;font-weight:500;transition:background 0.2s;';
          bottomBtn.addEventListener('mouseenter', function(){ bottomBtn.style.background = '#0599dc'; });
          bottomBtn.addEventListener('mouseleave', function(){ bottomBtn.style.background = '#06b3fd'; });
          bottomBtn.addEventListener('click', handleClick);
          
          // Add to placeholders
          const topPlaceholder = document.getElementById('complete-button-top');
          const bottomPlaceholder = document.getElementById('complete-button-bottom');
          
          if (topPlaceholder) topPlaceholder.appendChild(topBtn);
          if (bottomPlaceholder) bottomPlaceholder.appendChild(bottomBtn);
        });
    });
  }
  
  function markLessonComplete(uid, courseId, lessonId) {
    const db = firebase.firestore();
    const progressDoc = db.collection('users').doc(uid).collection('progress').doc(courseId);
    const practiceDoc = db.collection('users').doc(uid).collection('metrics').doc('practice');
    
    // Get lesson title from document.title
    const titleParts = document.title.split('|');
    const lessonTitle = titleParts.length > 1 ? titleParts[0].trim() : 'Lesson ' + lessonId;
    
    // Build lesson URL
    const parsed = courseId.match(/^([a-z]+)(\d+)$/);
    const lessonUrl = parsed ? '/vault/' + parsed[1] + '?c=' + parsed[2] + '&l=' + lessonId : '';
    
    // Update both progress completion AND last lesson tracking
    return Promise.all([
      progressDoc.set({
        completed: {
          [lessonId]: true
        }
      }, { merge: true }),
      practiceDoc.set({
        lastLessonUrl: lessonUrl,
        lastLessonTitle: lessonTitle,
        lastLessonViewedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true })
    ]);
  }
  
  function navigateToLesson(courseId, lessonId) {
    const parsed = courseId.match(/^([a-z]+)(\d+)$/);
    if (parsed) {
      window.location.href = ' + parsed[1] + '?c=' + parsed[2] + '&l=' + lessonId;
    }
  }
  
  function showError(message) {
    const container = document.getElementById('lesson-content');
    container.innerHTML = `<div style="padding:20px;border:2px solid #d00;background:#ffe;color:#d00;margin:20px;font-family:monospace;">${message}</div>`;
  }
})();
</script>
</body>
</html>
